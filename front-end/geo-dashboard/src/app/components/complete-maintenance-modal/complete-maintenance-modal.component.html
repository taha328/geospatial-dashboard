<div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" *ngIf="maintenance" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ maintenance?.statut === 'terminee' ? '📋 Réviser et Exporter le Rapport - ' : '✅ Terminer la Maintenance - ' }}{{ maintenance?.titre }}
        </h5>
        <button type="button" class="btn-close" (click)="close.emit()"></button>
      </div>
      <div class="modal-body">
        <form [formGroup]="completionForm" (ngSubmit)="onSubmit()">
          
          <!-- Dates Section -->
          <div class="form-section dates-section">
            <div class="section-title">
              <span class="section-icon">🕒</span>
              Dates d'Exécution
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="dateDebut" class="form-label">Date de Début Réelle <span class="text-danger">*</span></label>
                  <input type="datetime-local" id="dateDebut" formControlName="dateDebut" class="form-control">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="dateFin" class="form-label">Date de Fin Réelle <span class="text-danger">*</span></label>
                  <input type="datetime-local" id="dateFin" formControlName="dateFin" class="form-control">
                </div>
              </div>
            </div>
          </div>

          <!-- Cost Comparison Section -->
          <div class="form-section cost-comparison">
            <div class="section-title">
              <span class="section-icon">💰</span>
              Analyse des Coûts
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="coutEstime" class="form-label">Coût Estimé (MAD)</label>
                  <input type="number" id="coutEstime" [value]="maintenance?.coutEstime || 0" class="form-control" readonly>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="coutReel" class="form-label">Coût Réel (MAD) <span class="text-danger">*</span></label>
                  <input type="number" id="coutReel" formControlName="coutReel" class="form-control" step="0.01" min="0">
                </div>
              </div>
            </div>
            
            <!-- External Company -->
            <div class="mb-0">
              <label for="entrepriseExterne" class="form-label">Société Externe</label>
              <input type="text" id="entrepriseExterne" formControlName="entrepriseExterne" class="form-control" 
                     placeholder="Nom de la société externe (si applicable)">
            </div>
          </div>

          <!-- Execution Details Section -->
          <div class="form-section details-section">
            <div class="section-title">
              <span class="section-icon">📝</span>
              Détails d'Intervention
            </div>
            
            <!-- Intervention Report -->
            <div class="mb-3">
              <label for="rapportIntervention" class="form-label">Rapport d'Intervention <span class="text-danger">*</span></label>
              <textarea id="rapportIntervention" formControlName="rapportIntervention" class="form-control" rows="4" 
                        placeholder="Décrivez les travaux effectués, les problèmes rencontrés, et les solutions appliquées..."></textarea>
            </div>

            <!-- Replaced Parts -->
            <div class="mb-3">
              <label for="piecesRemplacees" class="form-label">Pièces Remplacées</label>
              <textarea id="piecesRemplacees" formControlName="piecesRemplacees" class="form-control" rows="3" 
                        placeholder="Liste des pièces remplacées avec références et quantités..."></textarea>
            </div>

            <!-- Document Annexe -->
            <div class="mb-0">
              <label for="documentAnnexe" class="form-label">Documents Annexes</label>
              <textarea id="documentAnnexe" formControlName="documentAnnexe" class="form-control" rows="2" 
                        placeholder="Références des documents, photos, ou certificats joints..."></textarea>
            </div>
          </div>

          <!-- Anomaly Resolution Section -->
          <div *ngIf="maintenance?.anomalieId" class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="resolveLinkedAnomaly" formControlName="resolveLinkedAnomaly">
            <label class="form-check-label" for="resolveLinkedAnomaly">
              <strong>Marquer l'anomalie liée comme résolue</strong><br>
              <small>Cette action fermera automatiquement l'anomalie associée à cette maintenance</small>
            </label>
          </div>

        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="close.emit()">Annuler</button>
        <button type="button" class="btn btn-primary" (click)="onSubmit()" [disabled]="completionForm.invalid || isSubmitting">
          {{ isSubmitting ? '⏳ Traitement...' : (maintenance?.statut === 'terminee' ? '📋 Mettre à Jour et Exporter' : '✅ Terminer la Maintenance') }}
        </button>
      </div>
    </div>
  </div>
</div>
