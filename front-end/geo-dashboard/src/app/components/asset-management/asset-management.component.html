<div class="asset-management-container">
  <!-- Header avec navigation -->
  <div class="asset-header">
    <div class="header-content">
      <h1>🏗️ Gestion des Actifs Portuaires</h1>
      <p>Système de gestion et suivi des infrastructures du Port de Tanger Med</p>
    </div>
    <div class="header-actions">
      <button 
        class="btn btn-primary"
        (click)="loadDashboardData()"
        title="Actualiser les données">
        <span class="btn-icon">🔄</span>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'dashboard'"
      (click)="setActiveTab('dashboard')">
      <span class="tab-icon">📊</span>
      Tableau de Bord
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'hierarchy'"
      (click)="setActiveTab('hierarchy')">
      <span class="tab-icon">🔗</span>
      Hiérarchie
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'assets'"
      (click)="setActiveTab('assets')">
      <span class="tab-icon">📋</span>
      Actifs
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'inspections'"
      (click)="setActiveTab('inspections')">
      <span class="tab-icon">🔍</span>
      Inspections
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'anomalies'"
      (click)="setActiveTab('anomalies')">
      <span class="tab-icon">⚠️</span>
      Anomalies
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'maintenance'"
      (click)="setActiveTab('maintenance')">
      <span class="tab-icon">�</span>
      Maintenance
    </button>
  </div>

  <!-- Error state -->
  <div *ngIf="error" class="error-container">
    <div class="error-icon">⚠️</div>
    <p>{{ error }}</p>
    <button class="btn btn-secondary" (click)="loadDashboardData()">Réessayer</button>
  </div>

  <!-- Main content -->
  <div class="main-content">
    
    <!-- Dashboard Tab -->
    <div class="tab-content" [class.active]="activeTab === 'dashboard'">
      <div class="dashboard-grid">
        
        <!-- KPI Cards -->
        <div class="kpi-section">
          <h2>📈 Indicateurs Clés de Performance</h2>
          <div class="kpi-grid">
            
            <!-- Actifs KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesActifs">
              <div class="kpi-header">
                <h3>🏗️ Actifs</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesActifs.total }}</span>
                  <span class="metric-label">Total Actifs</span>
                </div>
                <div class="metric-item success">
                  <span class="metric-value">{{ statistiquesActifs.operationnels }}</span>
                  <span class="metric-label">Opérationnels</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesActifs.enMaintenance }}</span>
                  <span class="metric-label">En Maintenance</span>
                </div>
                <div class="metric-item danger">
                  <span class="metric-value">{{ statistiquesActifs.horsService }}</span>
                  <span class="metric-label">Hors Service</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="availability-rate">
                  {{ formatPercentage(statistiquesActifs.tauxDisponibilite || 0) }} de disponibilité
                </span>
              </div>
            </div>

            <!-- Anomalies KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesAnomalies">
              <div class="kpi-header">
                <h3>⚠️ Anomalies</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesAnomalies.total }}</span>
                  <span class="metric-label">Total Anomalies</span>
                </div>
                <div class="metric-item info">
                  <span class="metric-value">{{ statistiquesAnomalies.nouvelles }}</span>
                  <span class="metric-label">Nouvelles</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesAnomalies.enCours }}</span>
                  <span class="metric-label">En Cours</span>
                </div>
                <div class="metric-item danger">
                  <span class="metric-value">{{ statistiquesAnomalies.critiques }}</span>
                  <span class="metric-label">Critiques</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="resolution-rate">
                  {{ formatPercentage(statistiquesAnomalies.tauxResolution || 0) }} de résolution
                </span>
              </div>
            </div>

            <!-- Maintenance KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesMaintenance">
              <div class="kpi-header">
                <h3>🔧 Maintenance</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesMaintenance.total }}</span>
                  <span class="metric-label">Total Maintenances</span>
                </div>
                <div class="metric-item info">
                  <span class="metric-value">{{ statistiquesMaintenance.planifiees }}</span>
                  <span class="metric-label">Planifiées</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesMaintenance.enCours }}</span>
                  <span class="metric-label">En Cours</span>
                </div>
                <div class="metric-item success">
                  <span class="metric-value">{{ statistiquesMaintenance.terminees }}</span>
                  <span class="metric-label">Terminées</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="cost-total">
                  {{ formatCurrency(statistiquesMaintenance.coutTotal || 0) }} de coûts
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats-section">
          <h2>📊 Statistiques Rapides</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">🔴</div>
              <div class="stat-content">
                <span class="stat-value">{{ getTotalAnomaliesActives() }}</span>
                <span class="stat-label">Anomalies Actives</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🔧</div>
              <div class="stat-content">
                <span class="stat-value">{{ getTotalMaintenancesPrevues() }}</span>
                <span class="stat-label">Maintenances Prévues</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">📦</div>
              <div class="stat-content">
                <span class="stat-value">{{ getUniqueTypes().length }}</span>
                <span class="stat-label">Types d'Actifs</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">🗺️</div>
              <div class="stat-content">
                <span class="stat-value">{{ actifsPourCarte.length }}</span>
                <span class="stat-label">Actifs Cartographiés</span>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- End dashboard-grid -->
    </div> <!-- End tab-content -->

    <!-- Hierarchy Tab -->
    <div class="tab-content" [class.active]="activeTab === 'hierarchy'">
      <div class="hierarchy-layout">
        <div class="hierarchy-tree">
          <h2>📊 Hiérarchie des Actifs</h2>
          <div class="tree-container">
            <div *ngFor="let portefeuille of hierarchyData" class="tree-node portefeuille">
              <div class="node-header" (click)="toggleNode('p' + portefeuille.id)">
                <span class="expand-icon">{{ isNodeExpanded('p' + portefeuille.id) ? '📂' : '📁' }}</span>
                <span class="node-icon">{{ getNodeIcon(portefeuille) }}</span>
                <span class="node-name">{{ portefeuille.nom }}</span>
                <span class="node-status" [style.color]="getStatutColor(portefeuille.statut || '')">
                  {{ portefeuille.statut }}
                </span>
              </div>
              
              <div class="node-children" *ngIf="isNodeExpanded('p' + portefeuille.id) && portefeuille.children">
                <div *ngFor="let famille of portefeuille.children" class="tree-node famille">
                  <div class="node-header" (click)="toggleNode('f' + famille.id)">
                    <span class="expand-icon">{{ isNodeExpanded('f' + famille.id) ? '📂' : '📁' }}</span>
                    <span class="node-icon">{{ getNodeIcon(famille) }}</span>
                    <span class="node-name">{{ famille.nom }}</span>
                    <span class="node-status" [style.color]="getStatutColor(famille.statut || '')">
                      {{ famille.statut }}
                    </span>
                  </div>
                  
                  <div class="node-children" *ngIf="isNodeExpanded('f' + famille.id) && famille.children">
                    <div *ngFor="let groupe of famille.children" class="tree-node groupe">
                      <div class="node-header" (click)="toggleNode('g' + groupe.id)">
                        <span class="expand-icon">{{ isNodeExpanded('g' + groupe.id) ? '📂' : '📁' }}</span>
                        <span class="node-icon">{{ getNodeIcon(groupe) }}</span>
                        <span class="node-name">{{ groupe.nom }}</span>
                        <span class="node-status" [style.color]="getStatutColor(groupe.statut || '')">
                          {{ groupe.statut }}
                        </span>
                      </div>
                      
                      <div class="node-children" *ngIf="isNodeExpanded('g' + groupe.id) && groupe.children">
                        <div *ngFor="let actif of groupe.children" class="tree-node actif" (click)="selectNode(actif)">
                          <div class="node-header" [class.selected]="selectedNode?.id === actif.id">
                            <span class="node-icon">{{ getNodeIcon(actif) }}</span>
                            <span class="node-name">{{ actif.nom }}</span>
                            <span class="node-code">{{ actif.code }}</span>
                            <span class="node-status" [style.color]="getStatutColor(actif.statutOperationnel || '')">
                              {{ actif.statutOperationnel }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Node Details -->
        <div class="node-details" *ngIf="selectedNode">
          <h3>📋 Détails de l'Actif</h3>
          <div class="details-card">
            <div class="details-header">
              <span class="details-icon">{{ getNodeIcon(selectedNode) }}</span>
              <h4>{{ selectedNode.nom }}</h4>
            </div>
            <div class="details-content">
              <div class="detail-row">
                <span class="detail-label">Code:</span>
                <span class="detail-value">{{ selectedNode.code }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Statut:</span>
                <span class="detail-value status-badge" [style.color]="getStatutColor(selectedNode.statutOperationnel || 'operationnel')">
                  {{ selectedNode.statutOperationnel || 'Non défini' }}
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">État:</span>
                <span class="detail-value" [style.color]="getEtatColor(selectedNode.etatGeneral || 'bon')">
                  {{ selectedNode.etatGeneral || 'Non défini' }}
                </span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Coordonnées:</span>
                <span class="detail-value coordinates">
                  {{ (selectedNode.latitude | number:'1.6-6') || 'N/A' }}, {{ (selectedNode.longitude | number:'1.6-6') || 'N/A' }}
                </span>
              </div>
            </div>
            <div class="details-actions" *ngIf="selectedActif">
              <button class="btn btn-warning btn-sm"
                      (click)="createAnomalieForActif(selectedActif, $event)"
                      title="Signaler une anomalie pour cet actif">
                ⚠️ Signaler Anomalie
              </button>
              <button class="btn btn-warning btn-sm"
                      (click)="updateActifStatut(selectedActif.id, 'maintenance')">
                🔧 Maintenance
              </button>
              <button class="btn btn-success btn-sm"
                      (click)="updateActifStatut(selectedActif.id, 'operationnel')">
                ✅ Opérationnel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Tab -->
    <div class="tab-content" [class.active]="activeTab === 'map'">
      <div class="map-section">
        <h2>🗺️ Carte Interactive des Actifs</h2>
        
        <!-- Map Controls -->
        <div class="map-controls">
          <div class="control-group">
            <select [(ngModel)]="selectedMapFilter" class="map-filter-select">
              <option value="tous">Tous les actifs</option>
              <option value="operationnel">Opérationnels</option>
              <option value="maintenance">En maintenance</option>
              <option value="hors_service">Hors service</option>
            </select>
          </div>

          <button class="btn btn-primary" (click)="centerMapOnActifs()">
            <span class="btn-icon">📍</span>
            Centrer sur les actifs
          </button>
        </div>

        <!-- Embedded Map -->
        <div class="embedded-map">
          <iframe 
            [src]="getMapUrl()" 
            width="100%" 
            height="500px" 
            frameborder="0"
            style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
          </iframe>
        </div>

        <!-- Map Legend -->
        <div class="map-legend">
          <h4>Légende</h4>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-color" style="background-color: #28a745;"></span>
              <span>Opérationnel</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #ffc107;"></span>
              <span>En maintenance</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #dc3545;"></span>
              <span>Hors service</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #fd7e14;"></span>
              <span>Alerte</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="map-actions">
          <button class="btn btn-warning" (click)="signalAnomalieFromMap()">
            <span class="btn-icon">⚠️</span>
            Signaler une anomalie
          </button>
          <button class="btn btn-info" (click)="openFullMap()">
            <span class="btn-icon">🔍</span>
            Ouvrir la carte complète
          </button>
        </div>
      </div>
    </div>

    <!-- Assets List Section - Enhanced -->
    <div class="tab-content" [class.active]="activeTab === 'assets'">
      <div class="assets-section">
        <div class="assets-header">
          <h2>📋 Liste des Actifs</h2>
          
          <!-- Enhanced Filters -->
          <div class="assets-filters">
            <div class="filter-group">
              <label>Statut:</label>
              <select [(ngModel)]="filtreStatut" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Tous les statuts</option>
                <option value="operationnel">Opérationnel</option>
                <option value="maintenance">En maintenance</option>
                <option value="hors_service">Hors service</option>
                <option value="alerte">Alerte</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Type:</label>
              <select [(ngModel)]="filtreType" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Tous les types</option>
                <option *ngFor="let type of getUniqueTypes()" [value]="type">{{ type }}</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Priorité:</label>
              <select [(ngModel)]="filtrePriorite" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Toutes priorités</option>
                <option value="critique">Critique (avec anomalies)</option>
                <option value="maintenance">Maintenance requise</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Recherche:</label>
              <input type="text" 
                     [(ngModel)]="rechercheTexte" 
                     (input)="onFilterChange()"
                     placeholder="Nom, code ou groupe..."
                     class="filter-input">
            </div>
          </div>
          
          <div class="assets-summary">
            <div class="summary-card">
              <span class="summary-count">{{ getFilteredActifs().length }}</span>
              <span class="summary-label">Actifs trouvés</span>
            </div>
            <div class="summary-card critical">
              <span class="summary-count">{{ getAssetsByPriority('critique').length }}</span>
              <span class="summary-label">Critiques</span>
            </div>
            <div class="summary-card warning">
              <span class="summary-count">{{ getAssetsByPriority('maintenance').length }}</span>
              <span class="summary-label">Maintenance requise</span>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Assets Grid -->
        <div class="assets-enhanced-grid">
          <div *ngFor="let actif of getFilteredActifs()" 
               class="asset-enhanced-card"
               [class.critical]="hasUrgentIssues(actif)"
               [class.maintenance-required]="needsMaintenance(actif)"
               (click)="selectActif(actif)">
               
            <!-- Asset Header -->
            <div class="asset-header-enhanced">
              <div class="asset-identity">
                <span class="asset-icon-enhanced">{{ getActifIcon(actif) }}</span>
                <div class="asset-title">
                  <h4>{{ actif.nom }}</h4>
                  <div class="asset-meta">
                    <span class="asset-code">{{ actif.code }}</span>
                    <span class="asset-group" *ngIf="actif.groupeNom">{{ actif.groupeNom }}</span>
                  </div>
                </div>
              </div>
              <div class="asset-status-badges">
                <span class="status-badge" [ngClass]="getStatusClass(actif.statutOperationnel)">
                  {{ actif.statutOperationnel }}
                </span>
                <span class="priority-badge" [ngClass]="getPriorityClass(actif)" *ngIf="getAssetPriority(actif) !== 'normal'">
                  {{ getAssetPriorityLabel(actif) }}
                </span>
              </div>
            </div>
            
            <!-- Asset Key Information -->
            <div class="asset-key-info">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Type:</span>
                  <span class="info-value">{{ actif.type }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">État:</span>
                  <span class="info-value" [style.color]="getEtatColor(actif.etatGeneral)">
                    {{ actif.etatGeneral }}
                  </span>
                </div>
                <div class="info-item" *ngIf="actif.familleNom">
                  <span class="info-label">Famille:</span>
                  <span class="info-value">{{ actif.familleNom }}</span>
                </div>
                <div class="info-item" *ngIf="actif.portefeuilleNom">
                  <span class="info-label">Portefeuille:</span>
                  <span class="info-value">{{ actif.portefeuilleNom }}</span>
                </div>
              </div>
            </div>
            
            <!-- Issues & Maintenance Summary -->
            <div class="asset-issues-summary" *ngIf="hasIssuesOrMaintenance(actif)">
              <div class="issues-header">
                <h5>🔍 État Actuel</h5>
              </div>
              
              <div class="issue-items">
                <!-- Active Anomalies -->
                <div class="issue-item anomaly" *ngIf="(actif['anomaliesActives'] || 0) > 0">
                  <div class="issue-icon">⚠️</div>
                  <div class="issue-details">
                    <span class="issue-count">{{ actif['anomaliesActives'] || 0 }}</span>
                    <span class="issue-label">Anomalie(s) active(s)</span>
                    <button class="issue-action-btn" 
                            (click)="viewAnomaliesForActif(actif, $event)"
                            title="Voir les anomalies">
                      👁️
                    </button>
                  </div>
                </div>
                
                <!-- Planned Maintenance -->
                <div class="issue-item maintenance" *ngIf="(actif['maintenancesPrevues'] || 0) > 0">
                  <div class="issue-icon">🔧</div>
                  <div class="issue-details">
                    <span class="issue-count">{{ actif['maintenancesPrevues'] || 0 }}</span>
                    <span class="issue-label">Maintenance(s) prévue(s)</span>
                    <button class="issue-action-btn" 
                            (click)="viewMaintenanceForActif(actif, $event)"
                            title="Voir les maintenances">
                      �️
                    </button>
                  </div>
                </div>
                
                <!-- No current issues -->
                <div class="issue-item normal" *ngIf="!hasIssuesOrMaintenance(actif)">
                  <div class="issue-icon">✅</div>
                  <div class="issue-details">
                    <span class="issue-label">Aucun problème signalé</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="asset-actions">
              <button class="action-btn primary" 
                      (click)="viewAssetDetails(actif, $event)"
                      title="Détails complets">
                📊 Détails
              </button>
              <button class="action-btn warning" 
                      (click)="createAnomalieForActif(actif, $event)"
                      title="Signaler une anomalie">
                ⚠️ Signaler
              </button>
              <button class="action-btn success" 
                      (click)="scheduleMaintenanceForActif(actif, $event)"
                      title="Planifier maintenance">
                🔧 Maintenance
              </button>
              <button class="action-btn info" 
                      (click)="showActifOnMap(actif, $event)"
                      title="Localiser sur la carte">
                🗺️ Carte
              </button>
            </div>
            
            <!-- Location Info -->
            <div class="asset-location" *ngIf="actif.latitude && actif.longitude">
              <span class="location-icon">📍</span>
              <span class="location-coords">
                {{ formatCoordinates(actif) }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Empty state -->
        <div class="empty-state" *ngIf="getFilteredActifs().length === 0">
          <div class="empty-icon">📭</div>
          <h3>Aucun actif trouvé</h3>
          <p>Essayez de modifier vos filtres ou votre recherche.</p>
        </div>
      </div>
    </div>

    <!-- Anomalies Tab -->
    <div class="tab-content" [class.active]="activeTab === 'anomalies'">
      <div class="anomalies-section">
        <!-- Main Header -->
        <div class="section-header-compact">
          <div class="header-content">
            <h2 class="section-title">
              <i class="section-icon">⚠️</i>
              Gestion des Anomalies
            </h2>
            <p class="section-subtitle">
              Signalement, analyse et résolution des dysfonctionnements détectés
            </p>
          </div>
        </div>


        <!-- Workflow Overview -->
        <div class="workflow-overview">
          <div class="workflow-card">
            <h3 class="workflow-title">Processus de Traitement</h3>
            <div class="workflow-steps">
              <div class="workflow-step">
                <div class="step-icon new">1</div>
                <div class="step-content">
                  <span class="step-name">Signalement</span>
                  <span class="step-desc">Détection et création</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon progress">2</div>
                <div class="step-content">
                  <span class="step-name">Analyse</span>
                  <span class="step-desc">Évaluation et diagnostic</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon maintenance">3</div>
                <div class="step-content">
                  <span class="step-name">Intervention</span>
                  <span class="step-desc">Maintenance corrective</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon resolved">✓</div>
                <div class="step-content">
                  <span class="step-name">Résolution</span>
                  <span class="step-desc">Validation et clôture</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Dashboard -->
        <div class="stats-dashboard">
          <div class="stats-grid">
            <div class="stat-card total">
              <div class="stat-icon">📊</div>
              <div class="stat-content">
                <div class="stat-number">{{ anomaliesData.length }}</div>
                <div class="stat-label">Total Anomalies</div>
              </div>
            </div>
            
            <div class="stat-card critical">
              <div class="stat-icon">🚨</div>
              <div class="stat-content">
                <div class="stat-number">{{ getAnomaliesByPriorite('critique').length }}</div>
                <div class="stat-label">Critiques</div>
              </div>
            </div>
            
            <div class="stat-card new">
              <div class="stat-icon">🆕</div>
              <div class="stat-content">
                <div class="stat-number">{{ getAnomaliesByStatut('nouveau').length }}</div>
                <div class="stat-label">Nouvelles</div>
              </div>
            </div>
            
            <div class="stat-card progress">
              <div class="stat-icon">⏳</div>
              <div class="stat-content">
                <div class="stat-number">{{ getAnomaliesByStatut('en_cours').length }}</div>
                <div class="stat-label">En Cours</div>
              </div>
            </div>
            
            <div class="stat-card maintenance">
              <div class="stat-icon">🔧</div>
              <div class="stat-content">
                <div class="stat-number">{{ getAnomaliesWithMaintenance().length }}</div>
                <div class="stat-label">En Maintenance</div>
              </div>
            </div>
            
            <div class="stat-card resolved">
              <div class="stat-icon">✅</div>
              <div class="stat-content">
                <div class="stat-number">{{ getAnomaliesByStatut('resolu').length }}</div>
                <div class="stat-label">Résolues</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters and Search -->
        <div class="controls-panel">
          <div class="search-box">
            <i class="search-icon">🔍</i>
            <input type="text" 
                   placeholder="Rechercher une anomalie..." 
                   [(ngModel)]="anomalieSearchTerm"
                   class="search-input">
          </div>
          <div class="filter-controls">
            <select class="filter-select" [(ngModel)]="selectedPriorityFilter">
              <option value="">Toutes les priorités</option>
              <option value="critique">Critique</option>
              <option value="eleve">Élevée</option>
              <option value="moyen">Moyenne</option>
              <option value="faible">Faible</option>
            </select>
            <select class="filter-select" [(ngModel)]="selectedStatusFilter">
              <option value="">Tous les statuts</option>
              <option value="nouveau">Nouveau</option>
              <option value="en_cours">En cours</option>
              <option value="resolu">Résolu</option>
            </select>
          </div>
        </div>

        <!-- Anomalies List -->
        <div class="anomalies-container">
          <div class="anomalies-grid">
            <div *ngFor="let anomalie of getFilteredAnomalies()" class="anomalie-card-modern" 
                 [class]="'priority-' + anomalie.priorite + ' status-' + anomalie.statut">
              
              <!-- Card Header -->
              <div class="card-header">
                <div class="priority-badge" [attr.data-priority]="anomalie.priorite">
                  <span class="priority-dot"></span>
                  {{ anomalie.priorite?.toUpperCase() }}
                </div>
                <div class="card-actions">
                  <button class="action-menu-btn" title="Options">⋯</button>
                </div>
              </div>

              <!-- Card Content -->
              <div class="card-content">
                <h3 class="anomalie-title">{{ anomalie.titre }}</h3>
                <p class="anomalie-description">{{ anomalie.description }}</p>
                
                <!-- Asset Info -->
                <div class="asset-info" *ngIf="anomalie.actif">
                  <i class="asset-icon">🏗️</i>
                  <span class="asset-name">{{ anomalie.actif.nom }}</span>
                  <span class="asset-code">({{ anomalie.actif.code }})</span>
                </div>
              </div>

              <!-- Progress Indicator -->
              <div class="progress-section">
                <div class="progress-header">
                  <span class="progress-label">Progression du traitement</span>
                  <span class="progress-percentage">{{ getAnomalieProgress(anomalie) }}%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="getAnomalieProgress(anomalie)"></div>
                </div>
                <div class="progress-steps">
                  <div class="step" [class.completed]="anomalie.statut !== 'nouveau'" 
                       [class.current]="anomalie.statut === 'nouveau'">
                    <div class="step-circle">1</div>
                    <span class="step-text">Signalement</span>
                  </div>
                  <div class="step" [class.completed]="['en_cours', 'resolu'].includes(anomalie.statut)" 
                       [class.current]="anomalie.statut === 'en_cours'">
                    <div class="step-circle">2</div>
                    <span class="step-text">Analyse</span>
                  </div>
                  <div class="step" [class.completed]="anomalie.maintenanceId && anomalie.maintenance?.statut === 'terminee'" 
                       [class.current]="anomalie.maintenanceId && anomalie.maintenance?.statut === 'en_cours'"
                       [class.optional]="!anomalie.maintenanceId">
                    <div class="step-circle">3</div>
                    <span class="step-text">Maintenance</span>
                  </div>
                  <div class="step" [class.completed]="anomalie.statut === 'resolu'" 
                       [class.current]="canResolveAnomalie(anomalie)">
                    <div class="step-circle">✓</div>
                    <span class="step-text">Résolution</span>
                  </div>
                </div>
              </div>

              <!-- Details Section -->
              <div class="details-section">
                <div class="detail-row">
                  <span class="detail-label">Type:</span>
                  <span class="detail-value">{{ anomalie.typeAnomalie }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Statut:</span>
                  <span class="detail-value status-badge" [attr.data-status]="anomalie.statut">
                    {{ getStatusLabel(anomalie.statut) }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Détecté le:</span>
                  <span class="detail-value">{{ anomalie.dateDetection | date:'dd/MM/yyyy à HH:mm' }}</span>
                </div>
                <div class="detail-row" *ngIf="anomalie.rapportePar">
                  <span class="detail-label">Rapporté par:</span>
                  <span class="detail-value">{{ anomalie.rapportePar }}</span>
                </div>
              </div>

              <!-- Actions Section -->
              <div class="actions-section" *ngIf="anomalie.statut !== 'resolu' && anomalie.statut !== 'ferme'">
                <div class="action-buttons">
                  <!-- Primary Action based on current state -->
                  <button class="btn-action primary" 
                          *ngIf="anomalie.statut === 'nouveau'"
                          (click)="takeAnomalieAction(anomalie)"
                          title="Prendre en charge cette anomalie">
                    <i class="btn-icon">📋</i>
                    Prendre en charge
                  </button>
                  
                  <button class="btn-action warning" 
                          *ngIf="anomalie.statut === 'en_cours' && !anomalie.maintenanceId"
                          (click)="openCreateMaintenanceFromAnomalieModal(anomalie)"
                          title="Créer une intervention de maintenance">
                    <i class="btn-icon">🔧</i>
                    Créer Maintenance
                  </button>
                  
                  <button class="btn-action info" 
                          *ngIf="anomalie.maintenanceId"
                          (click)="viewLinkedMaintenance(anomalie.maintenanceId)"
                          title="Consulter la maintenance associée">
                    <i class="btn-icon">👁️</i>
                    Voir Maintenance
                  </button>
                  
                  <button class="btn-action success" 
                          *ngIf="canResolveAnomalie(anomalie)"
                          (click)="resolveAnomalie(anomalie)"
                          title="Marquer cette anomalie comme résolue">
                    <i class="btn-icon">✅</i>
                    Résoudre
                  </button>
                </div>

                <!-- Status Indicator -->
                <div class="status-indicator" *ngIf="anomalie.maintenanceId && anomalie.maintenance && anomalie.maintenance.statut !== 'terminee'">
                  <i class="indicator-icon">🔄</i>
                  <span class="indicator-text">Maintenance en cours d'exécution</span>
                </div>
              </div>

              <!-- Resolution Summary for completed anomalies -->
              <div class="resolution-summary" *ngIf="anomalie.statut === 'resolu'">
                <div class="summary-header">
                  <i class="summary-icon">✅</i>
                  <span class="summary-title">Anomalie résolue</span>
                </div>
                <div class="summary-details" *ngIf="anomalie.dateResolution">
                  <span class="summary-text">Résolue le {{ anomalie.dateResolution | date:'dd/MM/yyyy à HH:mm' }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="getFilteredAnomalies().length === 0" class="empty-state-modern">
            <div class="empty-icon">📋</div>
            <h3 class="empty-title">Aucune anomalie trouvée</h3>
            <p class="empty-message">
              <span *ngIf="anomaliesData.length === 0">Aucune anomalie n'a été signalée pour le moment.</span>
              <span *ngIf="anomaliesData.length > 0">Aucune anomalie ne correspond aux critères de recherche.</span>
            </p>
            <button class="btn-empty-action" (click)="openCreateAnomalieModal()" *ngIf="anomaliesData.length === 0">
              <i class="btn-icon">+</i>
              Signaler une anomalie
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Maintenance Tab -->
    <div class="tab-content" [class.active]="activeTab === 'maintenance'">
      <div class="maintenance-section-modern">
        
        <!-- Section Header -->
        <div class="section-header-compact">
          <div class="header-content">
            <h2 class="section-title">
              <i class="section-icon">🔧</i>
              Gestion de la Maintenance
            </h2>
            <p class="section-subtitle">
              Planification, suivi et exécution des maintenances préventives et correctives
            </p>
          </div>
        </div>

        <!-- Enhanced Stats Dashboard -->
        <div class="stats-dashboard">
          <div class="stat-card total">
            <div class="stat-header">
              <span class="stat-icon">📊</span>
              <span class="stat-value">{{ maintenanceData.length }}</span>
            </div>
            <span class="stat-label">Total Maintenances</span>
          </div>
          
          <div class="stat-card planned">
            <div class="stat-header">
              <span class="stat-icon">📅</span>
              <span class="stat-value">{{ getMaintenancesByStatut('planifiee').length }}</span>
            </div>
            <span class="stat-label">Planifiées</span>
          </div>
          
          <div class="stat-card in-progress">
            <div class="stat-header">
              <span class="stat-icon">⚙️</span>
              <span class="stat-value">{{ getMaintenancesByStatut('en_cours').length }}</span>
            </div>
            <span class="stat-label">En Cours</span>
          </div>
          
          <div class="stat-card completed">
            <div class="stat-header">
              <span class="stat-icon">✅</span>
              <span class="stat-value">{{ getMaintenancesByStatut('terminee').length }}</span>
            </div>
            <span class="stat-label">Terminées</span>
          </div>
          
          <div class="stat-card urgent">
            <div class="stat-header">
              <span class="stat-icon">🚨</span>
              <span class="stat-value">{{ getMaintenancesByType('urgente').length }}</span>
            </div>
            <span class="stat-label">Urgentes</span>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filter-group">
            <label for="maintenanceStatusFilter">Statut</label>
            <select id="maintenanceStatusFilter" [(ngModel)]="maintenanceStatusFilter" class="filter-select">
              <option value="">Tous les statuts</option>
              <option value="planifiee">Planifiées</option>
              <option value="en_cours">En cours</option>
              <option value="terminee">Terminées</option>
              <option value="annulee">Annulées</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="maintenanceTypeFilter">Type</label>
            <select id="maintenanceTypeFilter" [(ngModel)]="maintenanceTypeFilter" class="filter-select">
              <option value="">Tous les types</option>
              <option value="preventive">Préventive</option>
              <option value="corrective">Corrective</option>
              <option value="urgente">Urgente</option>
              <option value="ameliorative">Améliorative</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="maintenanceSearchTerm">Recherche</label>
            <input type="text" id="maintenanceSearchTerm" [(ngModel)]="maintenanceSearchTerm" 
                   placeholder="Rechercher par titre, actif..." class="filter-input">
          </div>
          
          <button class="filter-reset-btn" (click)="resetMaintenanceFilters()">
            <i class="btn-icon">🔄</i>
            Réinitialiser
          </button>
        </div>

        <!-- Maintenance Cards Grid -->
        <div class="maintenance-container">
          <div class="maintenance-grid">
            <div *ngFor="let maintenance of getFilteredMaintenances()" 
                 class="maintenance-card-modern" 
                 [class]="'type-' + maintenance.typeMaintenance + ' status-' + maintenance.statut">
              
              <!-- Card Header -->
              <div class="card-header">
                <div class="type-badge" [attr.data-type]="maintenance.typeMaintenance">
                  <span class="type-icon">{{ getMaintenanceTypeIcon(maintenance.typeMaintenance) }}</span>
                  {{ maintenance.typeMaintenance?.toUpperCase() }}
                </div>
                <div class="status-indicator" [attr.data-status]="maintenance.statut">
                  {{ getMaintenanceStatusLabel(maintenance.statut) }}
                </div>
              </div>

              <!-- Card Content -->
              <div class="card-content">
                <h3 class="maintenance-title">{{ maintenance.titre }}</h3>
                <p class="maintenance-description">{{ maintenance.description }}</p>
                
                <!-- Asset Info -->
                <div class="asset-info" *ngIf="maintenance.actif">
                  <i class="asset-icon">🏗️</i>
                  <span class="asset-name">{{ maintenance.actif.nom }}</span>
                  <span class="asset-code">({{ maintenance.actif.code }})</span>
                </div>

                <!-- Anomaly Link -->
                <div class="anomaly-link" *ngIf="maintenance.anomalieId">
                  <i class="anomaly-icon">🚨</i>
                  <span class="anomaly-text">Liée à une anomalie</span>
                  <button class="link-btn" (click)="viewLinkedAnomalie(maintenance.anomalieId)">
                    Voir détails
                  </button>
                </div>
              </div>

              <!-- Timeline Section -->
              <div class="timeline-section">
                <div class="timeline-header">
                  <span class="timeline-label">Calendrier</span>
                  <span class="timeline-date">{{ maintenance.datePrevue | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="timeline-progress">
                  <div class="timeline-step" [class.completed]="maintenance.statut !== 'planifiee'">
                    <div class="step-circle">📅</div>
                    <span class="step-text">Planifiée</span>
                  </div>
                  <div class="timeline-step" [class.completed]="['en_cours', 'terminee'].includes(maintenance.statut)" 
                       [class.current]="maintenance.statut === 'en_cours'">
                    <div class="step-circle">⚙️</div>
                    <span class="step-text">En cours</span>
                  </div>
                  <div class="timeline-step" [class.completed]="maintenance.statut === 'terminee'">
                    <div class="step-circle">✅</div>
                    <span class="step-text">Terminée</span>
                  </div>
                </div>
              </div>

              <!-- Details Grid -->
              <div class="details-grid">
                <div class="detail-item" *ngIf="maintenance.technicienResponsable">
                  <span class="detail-label">Technicien</span>
                  <span class="detail-value">{{ maintenance.technicienResponsable }}</span>
                </div>
                <div class="detail-item" *ngIf="maintenance.coutEstime">
                  <span class="detail-label">Coût estimé</span>
                  <span class="detail-value">{{ formatCurrency(maintenance.coutEstime) }}</span>
                </div>
                <div class="detail-item" *ngIf="maintenance.dureeEstimee">
                  <span class="detail-label">Durée</span>
                  <span class="detail-value">{{ maintenance.dureeEstimee }}h</span>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="card-actions">
                <!-- Planned Maintenance Actions -->
                <button class="action-btn primary" 
                        *ngIf="maintenance.statut === 'planifiee'"
                        (click)="startMaintenance(maintenance)"
                        title="Démarrer la maintenance">
                  <i class="btn-icon">▶️</i>
                  Démarrer
                </button>
                
                <!-- In Progress Actions -->
                <button class="action-btn success" 
                        *ngIf="maintenance.statut === 'en_cours' && !maintenance.anomalieId"
                        (click)="completeMaintenance(maintenance)"
                        title="Terminer la maintenance">
                  <i class="btn-icon">✅</i>
                  Terminer
                </button>
                
                <!-- Complete with Anomaly Resolution -->
                <button class="action-btn success-secondary" 
                        *ngIf="maintenance.statut === 'en_cours' && maintenance.anomalieId"
                        (click)="completeMaintenanceAndResolveAnomalie(maintenance)"
                        title="Terminer la maintenance et marquer l'anomalie comme résolue">
                  <i class="btn-icon">✅🔧</i>
                  Terminer & Résoudre
                </button>
                
                <!-- View Details -->
                <button class="action-btn info" 
                        (click)="viewMaintenanceDetails(maintenance)"
                        title="Voir les détails">
                  <i class="btn-icon">👁️</i>
                  Détails
                </button>

                <!-- Export Report for completed maintenance -->
                <button class="action-btn export"
                        *ngIf="maintenance.statut === 'terminee'"
                        (click)="exportMaintenanceReport(maintenance)"
                        title="Exporter le rapport">
                  <i class="btn-icon">📄</i>
                  Exporter
                </button>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="getFilteredMaintenances().length === 0" class="empty-state-modern">
            <div class="empty-icon">🔧</div>
            <h3 class="empty-title">Aucune maintenance trouvée</h3>
            <p class="empty-message">
              <span *ngIf="maintenanceData.length === 0">Aucune maintenance n'a encore été planifiée.</span>
              <span *ngIf="maintenanceData.length > 0">Ajustez vos filtres pour voir plus de résultats.</span>
            </p>
            <button class="btn-modern btn-primary" 
                    *ngIf="maintenanceData.length === 0"
                    (click)="showCreateMaintenanceModal()">
              <i class="btn-icon">➕</i>
              Planifier une maintenance
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Inspections Tab -->
    <div class="tab-content" [class.active]="activeTab === 'inspections'">
      <div class="inspections-section-modern">
        
        <!-- Section Header -->
        <div class="section-header-compact">
          <div class="header-content">
            <h2 class="section-title">
              <i class="section-icon">🔍</i>
              Gestion des Inspections
            </h2>
            <p class="section-subtitle">
              Planification, suivi et exécution des inspections préventives et de contrôle qualité
            </p>
          </div>
        </div>

        <!-- Workflow Overview -->
        <div class="workflow-overview">
          <div class="workflow-card">
            <h3 class="workflow-title">Processus d'Inspection</h3>
            <div class="workflow-steps">
              <div class="workflow-step">
                <div class="step-icon planned">1</div>
                <div class="step-content">
                  <span class="step-name">Planification</span>
                  <span class="step-desc">Programmation et assignation</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon progress">2</div>
                <div class="step-content">
                  <span class="step-name">Exécution</span>
                  <span class="step-desc">Contrôle et évaluation</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon review">3</div>
                <div class="step-content">
                  <span class="step-name">Analyse</span>
                  <span class="step-desc">Rapport et recommandations</span>
                </div>
              </div>
              <div class="step-arrow">→</div>
              <div class="workflow-step">
                <div class="step-icon completed">✓</div>
                <div class="step-content">
                  <span class="step-name">Validation</span>
                  <span class="step-desc">Approbation et archivage</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Stats Dashboard -->
        <div class="stats-dashboard">
          <div class="stat-card total">
            <div class="stat-header">
              <span class="stat-icon">📊</span>
              <span class="stat-value">{{ inspectionsData.length }}</span>
            </div>
            <span class="stat-label">Total Inspections</span>
          </div>
          
          <div class="stat-card planned">
            <div class="stat-header">
              <span class="stat-icon">📅</span>
              <span class="stat-value">{{ getInspectionsByStatut('planifiee').length }}</span>
            </div>
            <span class="stat-label">Planifiées</span>
          </div>
          
          <div class="stat-card in-progress">
            <div class="stat-header">
              <span class="stat-icon">⚙️</span>
              <span class="stat-value">{{ getInspectionsByStatut('en_cours').length }}</span>
            </div>
            <span class="stat-label">En Cours</span>
          </div>
          
          <div class="stat-card completed">
            <div class="stat-header">
              <span class="stat-icon">✅</span>
              <span class="stat-value">{{ getInspectionsByStatut('terminee').length }}</span>
            </div>
            <span class="stat-label">Terminées</span>
          </div>
          
          <div class="stat-card overdue">
            <div class="stat-header">
              <span class="stat-icon">⏰</span>
              <span class="stat-value">{{ getOverdueInspections().length }}</span>
            </div>
            <span class="stat-label">En Retard</span>
          </div>
        </div>

        <!-- Filters Section -->
        <div class="filters-section">
          <div class="filter-group">
            <label for="inspectionStatusFilter">Statut</label>
            <select id="inspectionStatusFilter" [(ngModel)]="inspectionStatusFilter" class="filter-select">
              <option value="">Tous les statuts</option>
              <option value="planifiee">Planifiées</option>
              <option value="en_cours">En cours</option>
              <option value="terminee">Terminées</option>
              <option value="reportee">Reportées</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="inspectionTypeFilter">Type</label>
            <select id="inspectionTypeFilter" [(ngModel)]="inspectionTypeFilter" class="filter-select">
              <option value="">Tous les types</option>
              <option *ngFor="let type of availableInspectionTypes" [value]="type.id">
                {{ type.nom }}
              </option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="inspectionSearchTerm">Recherche</label>
            <input type="text" id="inspectionSearchTerm" [(ngModel)]="inspectionSearchTerm" 
                   placeholder="Rechercher par titre, actif..." class="filter-input">
          </div>
          
          <button class="filter-reset-btn" (click)="resetInspectionFilters()">
            <i class="btn-icon">🔄</i>
            Réinitialiser
          </button>
        </div>

        <!-- Inspections Cards Grid -->
        <div class="inspections-container">
          <div class="inspections-grid">
            <div *ngFor="let inspection of getFilteredInspections()" 
                 class="inspection-card-modern inspection-card-larger" 
                 [class]="'type-' + inspection.typeInspection?.nom + ' status-' + inspection.statut">
              
              <!-- Card Header -->
              <div class="card-header">
                <div class="type-badge" [attr.data-type]="inspection.typeInspection?.nom">
                  <span class="type-icon">🔍</span>
                  {{ inspection.typeInspection?.nom?.toUpperCase() || 'INSPECTION' }}
                </div>
                <div class="status-indicator" [attr.data-status]="inspection.statut">
                  {{ getInspectionStatusLabel(inspection.statut) }}
                </div>
              </div>

              <!-- Card Content -->
              <div class="card-content">
                <h3 class="inspection-title">{{ inspection.titre }}</h3>
                <p class="inspection-description">{{ inspection.description || 'Aucune description fournie' }}</p>
                
                <!-- Asset Info -->
                <div class="asset-info" *ngIf="inspection.actif">
                  <i class="asset-icon">🏗️</i>
                  <span class="asset-name">{{ inspection.actif.nom }}</span>
                  <span class="asset-code">({{ inspection.actif.code }})</span>
                </div>
              </div>

              <!-- Timeline Section -->
              <div class="timeline-section">
                <div class="timeline-header">
                  <span class="timeline-label">Calendrier</span>
                  <span class="timeline-date">{{ inspection.datePrevue | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="timeline-progress">
                  <div class="timeline-step" [class.completed]="inspection.statut !== 'planifiee'">
                    <div class="step-circle">📅</div>
                    <span class="step-text">Planifiée</span>
                  </div>
                  <div class="timeline-step" [class.completed]="['en_cours', 'terminee'].includes(inspection.statut)" 
                       [class.current]="inspection.statut === 'en_cours'">
                    <div class="step-circle">🔍</div>
                    <span class="step-text">En cours</span>
                  </div>
                  <div class="timeline-step" [class.completed]="inspection.statut === 'terminee'">
                    <div class="step-circle">✅</div>
                    <span class="step-text">Terminée</span>
                  </div>
                </div>
              </div>

              <!-- Details Grid -->
              <div class="details-grid">
                <div class="detail-item" *ngIf="inspection.inspecteur">
                  <span class="detail-label">Inspecteur</span>
                  <span class="detail-value">{{ inspection.inspecteur }}</span>
                </div>
                <div class="detail-item" *ngIf="inspection.dateCreation">
                  <span class="detail-label">Créée le</span>
                  <span class="detail-value">{{ inspection.dateCreation | date:'dd/MM/yyyy' }}</span>
                </div>
                <div class="detail-item" *ngIf="inspection.dureeEstimee">
                  <span class="detail-label">Durée</span>
                  <span class="detail-value">{{ inspection.dureeEstimee }}h</span>
                </div>
              </div>

              <!-- Results Section for completed inspections -->
              <div class="results-section" *ngIf="inspection.statut === 'terminee' && inspection.resultat">
                <div class="results-header">
                  <span class="results-icon">📋</span>
                  <span class="results-title">Résultat: {{ inspection.resultat }}</span>
                </div>
                <div class="conformity-indicator" [ngClass]="'conformity-' + inspection.resultat?.toLowerCase()">
                  <span class="conformity-text">
                    {{ inspection.resultat === 'conforme' ? '✅ Conforme' : 
                       inspection.resultat === 'non_conforme' ? '❌ Non Conforme' : 
                       '⚠️ Avec Réserves' }}
                  </span>
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="card-actions" style="display: flex !important; padding: 15px !important; border-top: 1px solid #ddd !important; background: #f8f9fa !important;">
                <!-- Complete Inspection Button - Only show for incomplete inspections -->
                <button class="action-btn success" 
                        *ngIf="inspection.statut !== 'terminee'"
                        (click)="openCompleteInspectionModal(inspection)"
                        title="Compléter l'inspection"
                        style="display: inline-flex !important; padding: 10px 20px !important; background: #28a745 !important; color: white !important; border: none !important; border-radius: 5px !important; cursor: pointer !important;">
                  <i class="btn-icon">✅</i>
                  Compléter l'Inspection
                </button>
                
                <!-- View Details -->
                <button class="action-btn info" 
                        (click)="viewInspectionDetails(inspection)"
                        title="Voir les détails">
                  <i class="btn-icon">👁️</i>
                  Détails
                </button>

                <!-- Export Report for completed inspection -->
                <button class="action-btn export"
                        *ngIf="inspection.statut === 'terminee'"
                        (click)="exportInspectionReport(inspection)"
                        title="Exporter le rapport">
                  <i class="btn-icon">📄</i>
                  Exporter
                </button>

                <!-- Schedule Anomaly Report for non-conforming inspections -->
                <button class="action-btn warning"
                        *ngIf="inspection.statut === 'terminee' && inspection.resultat === 'non_conforme'"
                        (click)="createAnomalieFromInspection(inspection)"
                        title="Signaler une anomalie suite à cette inspection">
                  <i class="btn-icon">⚠️</i>
                  Signaler Anomalie
                </button>
              </div>
            </div>
          </div>
          
          <!-- Empty State -->
          <div *ngIf="getFilteredInspections().length === 0" class="empty-state-modern">
            <div class="empty-icon">🔍</div>
            <h3 class="empty-title">Aucune inspection trouvée</h3>
            <p class="empty-message">
              <span *ngIf="inspectionsData.length === 0">Aucune inspection n'a encore été planifiée.</span>
              <span *ngIf="inspectionsData.length > 0">Ajustez vos filtres pour voir plus de résultats.</span>
            </p>
            <button class="btn-modern btn-primary" 
                    *ngIf="inspectionsData.length === 0"
                    (click)="showCreateInspectionModal()">
              <i class="btn-icon">➕</i>
              Planifier une inspection
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>


<!-- Asset Details Modal -->
<div class="modal fade" [class.show]="showAssetDetailsModal" [style.display]="showAssetDetailsModal ? 'block' : 'none'" *ngIf="showAssetDetailsModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Détails de l'Actif</h5>
        <button type="button" class="btn-close" (click)="closeAssetDetailsModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        <div class="asset-details-content">
          <div class="row">
            <div class="col-md-6">
              <h6>Informations Générales</h6>
              <dl class="row">
                <dt class="col-sm-4">Nom:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.nom }}</dd>
                <dt class="col-sm-4">Code:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.code }}</dd>
                <dt class="col-sm-4">Statut:</dt>
                <dd class="col-sm-8">
                  <span class="badge" [class]="'status-' + selectedAssetForAction.statutOperationnel">
                    {{ formatStatus(selectedAssetForAction.statutOperationnel) }}
                  </span>
                </dd>
                <dt class="col-sm-4">Priorité:</dt>
                <dd class="col-sm-8">
                  <span class="badge" [class]="'priority-' + getAssetPriority(selectedAssetForAction)">
                    {{ formatPriority(getAssetPriority(selectedAssetForAction)) }}
                  </span>
                </dd>
              </dl>
            </div>
            <div class="col-md-6">
              <h6>Hiérarchie & Localisation</h6>
              <dl class="row">
                <dt class="col-sm-4">Groupe:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.groupeNom || 'Non assigné' }}</dd>
                <dt class="col-sm-4">Famille:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.familleNom || 'Non assignée' }}</dd>
                <dt class="col-sm-4">Coordonnées:</dt>
                <dd class="col-sm-8">{{ formatCoordinates(selectedAssetForAction) }}</dd>
              </dl>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <h6>Anomalies Actives</h6>
              <div class="stat-box">
                <span class="stat-number">{{ getStatusCount(selectedAssetForAction, 'anomalies') }}</span>
                <span class="stat-label">anomalies en cours</span>
              </div>
            </div>
            <div class="col-md-6">
              <h6>Maintenances</h6>
              <div class="stat-box">
                <span class="stat-number">{{ getStatusCount(selectedAssetForAction, 'maintenance') }}</span>
                <span class="stat-label">maintenances prévues</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="createAnomalieForActif(selectedAssetForAction!, $event)">
          Signaler Anomalie
        </button>
        <button type="button" class="btn btn-success" (click)="scheduleMaintenanceForActif(selectedAssetForAction!, $event)">
          Planifier Maintenance
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeAssetDetailsModal()">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Anomalie Modal -->
<div class="modal fade" [class.show]="showCreateAnomalieModal" [style.display]="showCreateAnomalieModal ? 'block' : 'none'" *ngIf="showCreateAnomalieModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          🚨 Signaler une Anomalie
        </h5>
        <button type="button" class="btn-close" (click)="closeCreateAnomalieModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        
        <!-- Asset Information -->
        <div class="asset-info">
          <strong>🏭 Actif concerné:</strong> {{ selectedAssetForAction.nom }} ({{ selectedAssetForAction.code }})
        </div>
        
        <form [formGroup]="createAnomalieForm" (ngSubmit)="submitAnomalieForm()">
          
          <!-- Basic Information Section -->
          <div class="form-section anomaly-section">
            <div class="section-title">
              <span class="section-icon">📋</span>
              Informations Générales
            </div>
            
            <div class="mb-3">
              <label for="anomalieTitre" class="form-label">Titre de l'anomalie <span class="text-danger">*</span></label>
              <input 
                type="text" 
                class="form-control" 
                id="anomalieTitre" 
                formControlName="titre"
                [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'titre')"
                placeholder="Titre descriptif de l'anomalie">
              <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'titre')">
                {{ getFieldError(createAnomalieForm, 'titre') }}
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="anomalieType" class="form-label">Type d'anomalie <span class="text-danger">*</span></label>
                  <select 
                    class="form-select" 
                    id="anomalieType"
                    formControlName="typeAnomalie"
                    [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'typeAnomalie')">
                    <option value="">Sélectionner un type</option>
                    <option value="structural">🏗️ Structurel</option>
                    <option value="mecanique">⚙️ Mécanique</option>
                    <option value="electrique">⚡ Électrique</option>
                    <option value="securite">🛡️ Sécurité</option>
                    <option value="autre">📝 Autre</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'typeAnomalie')">
                    {{ getFieldError(createAnomalieForm, 'typeAnomalie') }}
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-0">
                  <label for="anomaliePriorite" class="form-label">Priorité <span class="text-danger">*</span></label>
                  <select 
                    class="form-select" 
                    id="anomaliePriorite"
                    formControlName="priorite"
                    [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'priorite')">
                    <option value="">Sélectionner une priorité</option>
                    <option value="faible">🟢 Faible</option>
                    <option value="moyen">🟡 Moyen</option>
                    <option value="eleve">🟠 Élevé</option>
                    <option value="critique">🔴 Critique</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'priorite')">
                    {{ getFieldError(createAnomalieForm, 'priorite') }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Description Section -->
          <div class="form-section">
            <div class="section-title">
              <span class="section-icon">📝</span>
              Description Détaillée
            </div>
            
            <div class="mb-0">
              <label for="anomalieDescription" class="form-label">Description de l'anomalie <span class="text-danger">*</span></label>
              <textarea 
                class="form-control" 
                id="anomalieDescription" 
                rows="4" 
                formControlName="description"
                [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'description')"
                placeholder="Décrivez l'anomalie en détail : symptômes observés, localisation exacte, conditions d'apparition, impact potentiel..."></textarea>
              <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'description')">
                {{ getFieldError(createAnomalieForm, 'description') }}
              </div>
            </div>
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="anomalieSubmitting || createAnomalieForm.invalid"
          (click)="submitAnomalieForm()">
          <span *ngIf="anomalieSubmitting" class="spinner-border spinner-border-sm"></span>
          {{ anomalieSubmitting ? '⏳ Création...' : '🚨 Créer Anomalie' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeCreateAnomalieModal()">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal fade" [class.show]="showScheduleMaintenanceModal" [style.display]="showScheduleMaintenanceModal ? 'block' : 'none'" *ngIf="showScheduleMaintenanceModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          🔧 Planifier une Maintenance
        </h5>
        <button type="button" class="btn-close" (click)="closeScheduleMaintenanceModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        
        <!-- Asset Information -->
        <div class="asset-info">
          <strong>🏭 Actif concerné:</strong> {{ selectedAssetForAction.nom }} ({{ selectedAssetForAction.code }})
        </div>
        
        <form [formGroup]="scheduleMaintenanceForm" (ngSubmit)="submitMaintenanceForm()">
          
          <!-- Basic Information Section -->
          <div class="form-section maintenance-section">
            <div class="section-title">
              <span class="section-icon">📋</span>
              Informations Générales
            </div>
            
            <div class="mb-3">
              <label for="maintenanceTitre" class="form-label">Titre de la maintenance <span class="text-danger">*</span></label>
              <input id="maintenanceTitre" type="text" class="form-control" formControlName="titre" 
                     placeholder="Titre descriptif de la maintenance">
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenanceType" class="form-label">Type de maintenance <span class="text-danger">*</span></label>
                  <select id="maintenanceType" class="form-select" formControlName="typeMaintenance">
                    <option value="">Sélectionner le type</option>
                    <option value="preventive">🛡️ Préventive</option>
                    <option value="corrective">🔧 Corrective</option>
                    <option value="urgente">🚨 Urgente</option>
                    <option value="ameliorative">⚡ Améliorative</option>
                  </select>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-0">
                  <label for="maintenanceDate" class="form-label">Date prévue <span class="text-danger">*</span></label>
                  <input id="maintenanceDate" type="date" class="form-control" formControlName="datePrevue">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Description Section -->
          <div class="form-section">
            <div class="section-title">
              <span class="section-icon">📝</span>
              Description et Détails
            </div>
            
            <div class="mb-3">
              <label for="maintenanceDescription" class="form-label">Description des travaux <span class="text-danger">*</span></label>
              <textarea id="maintenanceDescription" class="form-control" formControlName="description" rows="4"
                        placeholder="Décrivez en détail les travaux à effectuer, les objectifs, et les procédures..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-0">
                  <label for="maintenanceCout" class="form-label">Coût estimé (MAD)</label>
                  <input id="maintenanceCout" type="number" class="form-control" formControlName="coutEstime" min="0" step="0.01"
                         placeholder="0.00">
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-0">
                  <label for="maintenanceTechnicien" class="form-label">Technicien responsable</label>
                  <input id="maintenanceTechnicien" type="text" class="form-control" formControlName="technicienResponsable" 
                         placeholder="Nom du technicien assigné">
                </div>
              </div>
            </div>
          </div>
          
        </form>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success" [disabled]="maintenanceSubmitting || scheduleMaintenanceForm.invalid"
                (click)="submitMaintenanceForm()">
          <span *ngIf="maintenanceSubmitting" class="spinner-border spinner-border-sm"></span>
          {{ maintenanceSubmitting ? '⏳ Enregistrement...' : '🔧 Planifier' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeScheduleMaintenanceModal()">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Maintenance From Anomalie Modal -->
<div class="modal fade" [class.show]="showCreateMaintenanceFromAnomalieModal" [style.display]="showCreateMaintenanceFromAnomalieModal ? 'block' : 'none'" *ngIf="showCreateMaintenanceFromAnomalieModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Créer une Maintenance pour l'Anomalie</h5>
        <button type="button" class="btn-close" (click)="closeCreateMaintenanceFromAnomalieModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAnomalieForMaintenance">
        <p><strong>Anomalie concernée:</strong> {{ selectedAnomalieForMaintenance.titre }} ({{ selectedAnomalieForMaintenance.actif?.nom }})</p>
        <form [formGroup]="scheduleMaintenanceForm" (ngSubmit)="submitMaintenanceForm()">
          <!-- Form fields (see below) -->
          <div class="mb-3">
            <label for="maintenanceTitreAnomalie" class="form-label">Titre *</label>
            <input id="maintenanceTitreAnomalie" type="text" class="form-control" formControlName="titre" placeholder="Titre de la maintenance">
          </div>
          <div class="mb-3">
            <label for="maintenanceTypeAnomalie" class="form-label">Type *</label>
            <select id="maintenanceTypeAnomalie" class="form-control" formControlName="typeMaintenance">
              <option value="">Sélectionner le type</option>
              <option value="preventive">Préventive</option>
              <option value="corrective">Corrective</option>
              <option value="urgente">Urgente</option>
              <option value="ameliorative">Améliorative</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="maintenanceDateAnomalie" class="form-label">Date prévue *</label>
            <input id="maintenanceDateAnomalie" type="date" class="form-control" formControlName="datePrevue">
          </div>
          <div class="mb-3">
            <label for="maintenanceDescriptionAnomalie" class="form-label">Description *</label>
            <textarea id="maintenanceDescriptionAnomalie" class="form-control" formControlName="description" placeholder="Description détaillée"></textarea>
          </div>
          <div class="mb-3">
            <label for="maintenanceCoutAnomalie" class="form-label">Coût estimé</label>
            <input id="maintenanceCoutAnomalie" type="number" class="form-control" formControlName="coutEstime" min="0">
          </div>
          <div class="mb-3">
            <label for="maintenanceTechnicienAnomalie" class="form-label">Technicien responsable</label>
            <input id="maintenanceTechnicienAnomalie" type="text" class="form-control" formControlName="technicienResponsable" placeholder="Nom du technicien">
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success" [disabled]="maintenanceSubmitting || scheduleMaintenanceForm.invalid">
              {{ maintenanceSubmitting ? 'Enregistrement...' : 'Créer' }}
            </button>
            <button type="button" class="btn btn-secondary" (click)="closeCreateMaintenanceFromAnomalieModal()">Annuler</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Maintenance Details Modal -->
<div class="modal fade" [class.show]="showMaintenanceDetailsModal" [style.display]="showMaintenanceDetailsModal ? 'block' : 'none'" *ngIf="showMaintenanceDetailsModal">
  <div class="modal-dialog modal-xl">
    <div class="modal-content maintenance-details-content">
      <div class="modal-header modern-header">
        <div class="header-content">
          <div class="title-section">
            <span class="main-icon">🔧</span>
            <div class="title-text">
              <h4 class="modal-title">Détails de la Maintenance</h4>
              <p class="subtitle">{{ selectedMaintenanceForDetails.titre }}</p>
            </div>
          </div>
          <div class="status-badge">
            <span class="badge status-{{ selectedMaintenanceForDetails.statut }}">
              {{ selectedMaintenanceForDetails.statut | titlecase }}
            </span>
          </div>
        </div>
        <button type="button" class="btn-close modern-close" (click)="closeMaintenanceDetailsModal()"></button>
      </div>
      
      <div class="modal-body modern-body" *ngIf="selectedMaintenanceForDetails">
        
        <!-- Quick Info Cards Row -->
        <div class="quick-info-row">
          <div class="info-card type-card">
            <div class="card-icon">⚙️</div>
            <div class="card-content">
              <span class="card-label">Type</span>
              <span class="card-value">{{ selectedMaintenanceForDetails.typeMaintenance | titlecase }}</span>
            </div>
          </div>
          
          <div class="info-card date-card">
            <div class="card-icon">📅</div>
            <div class="card-content">
              <span class="card-label">Date Prévue</span>
              <span class="card-value">{{ selectedMaintenanceForDetails.datePrevue | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
          
          <div class="info-card cost-card">
            <div class="card-icon">💰</div>
            <div class="card-content">
              <span class="card-label">Coût Estimé</span>
              <span class="card-value">{{ formatCurrency(selectedMaintenanceForDetails.coutEstime) }}</span>
            </div>
          </div>
          
          <div class="info-card tech-card">
            <div class="card-icon">👨‍🔧</div>
            <div class="card-content">
              <span class="card-label">Technicien</span>
              <span class="card-value">{{ selectedMaintenanceForDetails.technicienResponsable || 'Non assigné' }}</span>
            </div>
          </div>
        </div>
        
        <!-- Main Content Sections -->
        <div class="content-sections">
          
          <!-- Description Section -->
          <div class="section-card description-section">
            <div class="section-header">
              <div class="section-icon">📝</div>
              <h5 class="section-title">Description des Travaux</h5>
            </div>
            <div class="section-content">
              <div class="description-box">
                <p>{{ selectedMaintenanceForDetails.description || 'Aucune description fournie' }}</p>
              </div>
            </div>
          </div>
          
          <!-- Execution Details Grid -->
          <div class="execution-grid">
            
            <!-- Intervention Report -->
            <div class="section-card report-section">
              <div class="section-header">
                <div class="section-icon">📋</div>
                <h5 class="section-title">Rapport d'Intervention</h5>
              </div>
              <div class="section-content">
                <div class="report-content">
                  <div class="content-display">
                    {{ selectedMaintenanceForDetails.rapportIntervention || 'Rapport non encore disponible' }}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Replaced Parts -->
            <div class="section-card parts-section">
              <div class="section-header">
                <div class="section-icon">🔩</div>
                <h5 class="section-title">Pièces Remplacées</h5>
              </div>
              <div class="section-content">
                <div class="parts-list">
                  <div class="content-display">
                    <ng-container *ngIf="selectedMaintenanceForDetails.piecesRemplacees; else noParts">
                      <div class="parts-items">
                        <div *ngFor="let piece of getPiecesArray(selectedMaintenanceForDetails.piecesRemplacees)" class="part-item">
                          <span class="part-bullet">•</span>
                          <span class="part-text">{{ piece }}</span>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #noParts>
                      <span class="no-data">Aucune pièce remplacée</span>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- External Company Section -->
          <div class="section-card company-section" *ngIf="selectedMaintenanceForDetails.entrepriseExterne">
            <div class="section-header">
              <div class="section-icon">🏢</div>
              <h5 class="section-title">Entreprise Externe</h5>
            </div>
            <div class="section-content">
              <div class="company-info">
                <div class="company-name">
                  {{ selectedMaintenanceForDetails.entrepriseExterne }}
                </div>
              </div>
            </div>
          </div>
          
        </div>
        
      </div>
      
      <div class="modal-footer modern-footer">
        <button type="button" class="btn btn-secondary modern-btn" (click)="closeMaintenanceDetailsModal()">
          <span class="btn-icon">✕</span>
          Fermer
        </button>
        <button type="button" class="btn btn-primary modern-btn" *ngIf="selectedMaintenanceForDetails.statut === 'terminee'">
          <span class="btn-icon">📄</span>
          Générer Rapport PDF
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Complete Maintenance Modal -->
<app-complete-maintenance-modal
  *ngIf="showCompleteMaintenanceModal"
  [maintenance]="selectedMaintenanceForCompletion"
  (completed)="onMaintenanceCompleted($event)"
  (close)="onCompletionCancelled()">
</app-complete-maintenance-modal>

<!-- Complete Inspection Modal -->
<div class="modal fade show" style="display: block; background: rgba(0,0,0,0.5);" *ngIf="showCompleteInspectionModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-inspection-large">
    <div class="modal-content modern-modal">
      <div class="modal-header modern-header">
        <h5 class="modal-title">
          🔍 Compléter l'Inspection - {{ selectedInspectionForCompletion?.titre }}
        </h5>
        <button type="button" class="btn-close modern-close" (click)="closeCompleteInspectionModal()"></button>
      </div>
      
      <div class="modal-body" *ngIf="selectedInspectionForCompletion">
        <form [formGroup]="inspectionCompletionForm" class="inspection-completion-form">
          
          <!-- Asset Information Display -->
          <div class="form-section info-section">
            <div class="section-title">
              <span class="section-icon">🏗️</span>
              Actif Inspecté
            </div>
            <div class="asset-info-display">
              <div class="info-item">
                <span class="info-label">Nom:</span>
                <span class="info-value">{{ selectedInspectionForCompletion?.actif?.nom }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Code:</span>
                <span class="info-value">{{ selectedInspectionForCompletion?.actif?.code }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Type:</span>
                <span class="info-value">{{ selectedInspectionForCompletion?.typeInspection?.typeInspection }}</span>
              </div>
            </div>
          </div>

          <!-- Inspection Details Section -->
          <div class="form-section details-section">
            <div class="section-title">
              <span class="section-icon">📋</span>
              Détails de l'Inspection
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="dateRealisation">Date de Réalisation *</label>
                  <input 
                    type="date" 
                    id="dateRealisation"
                    class="form-control" 
                    formControlName="dateRealisation"
                    [value]="getCurrentDate()">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="inspecteurResponsable">Inspecteur Responsable</label>
                  <input 
                    type="text" 
                    id="inspecteurResponsable"
                    class="form-control" 
                    formControlName="inspecteurResponsable"
                    placeholder="Nom de l'inspecteur">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="organismeInspection">Organisme d'Inspection</label>
                  <input 
                    type="text" 
                    id="organismeInspection"
                    class="form-control" 
                    formControlName="organismeInspection"
                    placeholder="Nom de l'organisme">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="coutInspection">Coût de l'Inspection (€)</label>
                  <input 
                    type="number" 
                    id="coutInspection"
                    class="form-control" 
                    formControlName="coutInspection"
                    placeholder="0.00">
                </div>
              </div>
            </div>
          </div>

          <!-- Results Section -->
          <div class="form-section results-section">
            <div class="section-title">
              <span class="section-icon">📊</span>
              Résultats de l'Inspection
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="resultatGeneral">Résultat Général *</label>
                  <select 
                    id="resultatGeneral"
                    class="form-control" 
                    formControlName="resultatGeneral">
                    <option value="">Sélectionner un résultat</option>
                    <option value="bon">Bon</option>
                    <option value="moyen">Moyen</option>
                    <option value="mauvais">Mauvais</option>
                    <option value="critique">Critique</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="conformite">Conformité *</label>
                  <select 
                    id="conformite"
                    class="form-control" 
                    formControlName="conformite">
                    <option value="">Sélectionner la conformité</option>
                    <option value="conforme">Conforme</option>
                    <option value="non_conforme">Non Conforme</option>
                    <option value="avec_reserves">Avec Réserves</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="form-group">
              <label for="mesuresRelevees">Mesures Relevées</label>
              <textarea 
                id="mesuresRelevees"
                class="form-control" 
                formControlName="mesuresRelevees"
                rows="3"
                placeholder="Détails des mesures effectuées..."></textarea>
            </div>
            
            <div class="form-group">
              <label for="observations">Observations</label>
              <textarea 
                id="observations"
                class="form-control" 
                formControlName="observations"
                rows="3"
                placeholder="Observations générales..."></textarea>
            </div>
            
            <div class="form-group">
              <label for="recommandations">Recommandations</label>
              <textarea 
                id="recommandations"
                class="form-control" 
                formControlName="recommandations"
                rows="3"
                placeholder="Recommandations pour l'avenir..."></textarea>
            </div>
          </div>

          <!-- Documents Section -->
          <div class="form-section documents-section">
            <div class="section-title">
              <span class="section-icon">📎</span>
              Documents et Photos
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="photosRapport">Photos du Rapport</label>
                  <input 
                    type="file" 
                    id="photosRapport"
                    class="form-control file-input" 
                    accept="image/*"
                    multiple
                    (change)="onPhotosSelected($event)"
                    #photosInput>
                  <small class="form-text text-muted">
                    Sélectionnez une ou plusieurs images (JPG, PNG, etc.)
                  </small>
                  <div class="selected-files-preview" *ngIf="selectedPhotos.length > 0">
                    <div class="file-preview" *ngFor="let photo of selectedPhotos; let i = index">
                      <span class="file-name">{{ photo.name }}</span>
                      <button type="button" class="btn-remove" (click)="removePhoto(i)">&times;</button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="documentsAnnexes">Documents Annexes</label>
                  <input 
                    type="file" 
                    id="documentsAnnexes"
                    class="form-control file-input" 
                    accept=".pdf,.doc,.docx,.txt,.xls,.xlsx"
                    multiple
                    (change)="onDocumentsSelected($event)"
                    #documentsInput>
                  <small class="form-text text-muted">
                    Sélectionnez des documents (PDF, Word, Excel, etc.)
                  </small>
                  <div class="selected-files-preview" *ngIf="selectedDocuments.length > 0">
                    <div class="file-preview" *ngFor="let doc of selectedDocuments; let i = index">
                      <span class="file-name">{{ doc.name }}</span>
                      <button type="button" class="btn-remove" (click)="removeDocument(i)">&times;</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>
      
      <div class="modal-footer modern-footer">
        <button type="button" class="btn btn-secondary modern-btn" (click)="closeCompleteInspectionModal()">
          <span class="btn-icon">✕</span>
          Annuler
        </button>
        
        <!-- Complete without anomaly -->
        <button 
          type="button" 
          class="btn btn-success modern-btn" 
          (click)="completeInspectionSuccessfully()"
          [disabled]="!inspectionCompletionForm.valid">
          <span class="btn-icon">✅</span>
          Terminer sans Anomalie
        </button>
        
        <!-- Complete with anomaly -->
        <button 
          type="button" 
          class="btn btn-warning modern-btn" 
          (click)="completeInspectionWithAnomalie()"
          [disabled]="!inspectionCompletionForm.valid">
          <span class="btn-icon">⚠️</span>
          Créer Anomalie
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade show" *ngIf="showAssetDetailsModal || showCreateAnomalieModal || showScheduleMaintenanceModal || showMaintenanceDetailsModal || showCompleteMaintenanceModal || showCompleteInspectionModal"></div>