<div class="asset-management-container">
  <!-- Header avec navigation -->
  <div class="asset-header">
    <div class="header-content">
      <h1>üèóÔ∏è Gestion des Actifs Portuaires</h1>
      <p>Syst√®me de gestion et suivi des infrastructures du Port de Tanger Med</p>
    </div>
    <div class="header-actions">
      <button 
        class="btn btn-primary"
        (click)="loadDashboardData()"
        title="Actualiser les donn√©es">
        <span class="btn-icon">üîÑ</span>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Navigation par onglets -->
  <div class="tab-navigation">
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'dashboard'"
      (click)="setActiveTab('dashboard')">
      <span class="tab-icon">üìä</span>
      Tableau de Bord
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'hierarchy'"
      (click)="setActiveTab('hierarchy')">
      <span class="tab-icon">üå≥</span>
      Hi√©rarchie
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'map'"
      (click)="setActiveTab('map')">
      <span class="tab-icon">üó∫Ô∏è</span>
      Carte
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'assets'"
      (click)="setActiveTab('assets')">
      <span class="tab-icon">üìã</span>
      Actifs
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'anomalies'"
      (click)="setActiveTab('anomalies')">
      <span class="tab-icon">‚ö†Ô∏è</span>
      Anomalies
    </button>
    <button 
      class="tab-btn"
      [class.active]="activeTab === 'maintenance'"
      (click)="setActiveTab('maintenance')">
      <span class="tab-icon">üîß</span>
      Maintenance
    </button>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Chargement des donn√©es...</p>
  </div>

  <!-- Error state -->
  <div *ngIf="error" class="error-container">
    <div class="error-icon">‚ö†Ô∏è</div>
    <p>{{ error }}</p>
    <button class="btn btn-secondary" (click)="loadDashboardData()">R√©essayer</button>
  </div>

  <!-- Main content -->
  <div class="main-content" *ngIf="!loading && !error">
    
    <!-- Dashboard Tab -->
    <div class="tab-content" [class.active]="activeTab === 'dashboard'">
      <div class="dashboard-grid">
        
        <!-- KPI Cards -->
        <div class="kpi-section">
          <h2>üìà Indicateurs Cl√©s de Performance</h2>
          <div class="kpi-grid">
            
            <!-- Actifs KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesActifs">
              <div class="kpi-header">
                <h3>üèóÔ∏è Actifs</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesActifs.total }}</span>
                  <span class="metric-label">Total Actifs</span>
                </div>
                <div class="metric-item success">
                  <span class="metric-value">{{ statistiquesActifs.operationnels }}</span>
                  <span class="metric-label">Op√©rationnels</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesActifs.enMaintenance }}</span>
                  <span class="metric-label">En Maintenance</span>
                </div>
                <div class="metric-item danger">
                  <span class="metric-value">{{ statistiquesActifs.horsService }}</span>
                  <span class="metric-label">Hors Service</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="availability-rate">
                  {{ formatPercentage(statistiquesActifs.tauxDisponibilite || 0) }} de disponibilit√©
                </span>
              </div>
            </div>

            <!-- Anomalies KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesAnomalies">
              <div class="kpi-header">
                <h3>‚ö†Ô∏è Anomalies</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesAnomalies.total }}</span>
                  <span class="metric-label">Total Anomalies</span>
                </div>
                <div class="metric-item info">
                  <span class="metric-value">{{ statistiquesAnomalies.nouvelles }}</span>
                  <span class="metric-label">Nouvelles</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesAnomalies.enCours }}</span>
                  <span class="metric-label">En Cours</span>
                </div>
                <div class="metric-item danger">
                  <span class="metric-value">{{ statistiquesAnomalies.critiques }}</span>
                  <span class="metric-label">Critiques</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="resolution-rate">
                  {{ formatPercentage(statistiquesAnomalies.tauxResolution || 0) }} de r√©solution
                </span>
              </div>
            </div>

            <!-- Maintenance KPI - Fix property names -->
            <div class="kpi-card" *ngIf="statistiquesMaintenance">
              <div class="kpi-header">
                <h3>üîß Maintenance</h3>
              </div>
              <div class="kpi-metrics">
                <div class="metric-item primary">
                  <span class="metric-value">{{ statistiquesMaintenance.total }}</span>
                  <span class="metric-label">Total Maintenances</span>
                </div>
                <div class="metric-item info">
                  <span class="metric-value">{{ statistiquesMaintenance.planifiees }}</span>
                  <span class="metric-label">Planifi√©es</span>
                </div>
                <div class="metric-item warning">
                  <span class="metric-value">{{ statistiquesMaintenance.enCours }}</span>
                  <span class="metric-label">En Cours</span>
                </div>
                <div class="metric-item success">
                  <span class="metric-value">{{ statistiquesMaintenance.terminees }}</span>
                  <span class="metric-label">Termin√©es</span>
                </div>
              </div>
              <div class="kpi-footer">
                <span class="cost-total">
                  {{ formatCurrency(statistiquesMaintenance.coutTotal || 0) }} de co√ªts
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats-section">
          <h2>üìä Statistiques Rapides</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üî¥</div>
              <div class="stat-content">
                <span class="stat-value">{{ getTotalAnomaliesActives() }}</span>
                <span class="stat-label">Anomalies Actives</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üîß</div>
              <div class="stat-content">
                <span class="stat-value">{{ getTotalMaintenancesPrevues() }}</span>
                <span class="stat-label">Maintenances Pr√©vues</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üì¶</div>
              <div class="stat-content">
                <span class="stat-value">{{ getUniqueTypes().length }}</span>
                <span class="stat-label">Types d'Actifs</span>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üó∫Ô∏è</div>
              <div class="stat-content">
                <span class="stat-value">{{ actifsPourCarte.length }}</span>
                <span class="stat-label">Actifs Cartographi√©s</span>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- End dashboard-grid -->
    </div> <!-- End tab-content -->

    <!-- Hierarchy Tab -->
    <div class="tab-content" [class.active]="activeTab === 'hierarchy'">
      <div class="hierarchy-layout">
        <div class="hierarchy-tree">
          <h2>üå≥ Hi√©rarchie des Actifs</h2>
          <div class="tree-container">
            <div *ngFor="let portefeuille of hierarchyData" class="tree-node portefeuille">
              <div class="node-header" (click)="toggleNode('p' + portefeuille.id)">
                <span class="expand-icon">{{ isNodeExpanded('p' + portefeuille.id) ? 'üìÇ' : 'üìÅ' }}</span>
                <span class="node-icon">{{ getNodeIcon(portefeuille) }}</span>
                <span class="node-name">{{ portefeuille.nom }}</span>
                <span class="node-status" [style.color]="getStatutColor(portefeuille.statut || '')">
                  {{ portefeuille.statut }}
                </span>
              </div>
              
              <div class="node-children" *ngIf="isNodeExpanded('p' + portefeuille.id) && portefeuille.children">
                <div *ngFor="let famille of portefeuille.children" class="tree-node famille">
                  <div class="node-header" (click)="toggleNode('f' + famille.id)">
                    <span class="expand-icon">{{ isNodeExpanded('f' + famille.id) ? 'üìÇ' : 'üìÅ' }}</span>
                    <span class="node-icon">{{ getNodeIcon(famille) }}</span>
                    <span class="node-name">{{ famille.nom }}</span>
                    <span class="node-status" [style.color]="getStatutColor(famille.statut || '')">
                      {{ famille.statut }}
                    </span>
                  </div>
                  
                  <div class="node-children" *ngIf="isNodeExpanded('f' + famille.id) && famille.children">
                    <div *ngFor="let groupe of famille.children" class="tree-node groupe">
                      <div class="node-header" (click)="toggleNode('g' + groupe.id)">
                        <span class="expand-icon">{{ isNodeExpanded('g' + groupe.id) ? 'üìÇ' : 'üìÅ' }}</span>
                        <span class="node-icon">{{ getNodeIcon(groupe) }}</span>
                        <span class="node-name">{{ groupe.nom }}</span>
                        <span class="node-status" [style.color]="getStatutColor(groupe.statut || '')">
                          {{ groupe.statut }}
                        </span>
                      </div>
                      
                      <div class="node-children" *ngIf="isNodeExpanded('g' + groupe.id) && groupe.children">
                        <div *ngFor="let actif of groupe.children" class="tree-node actif" (click)="selectNode(actif)">
                          <div class="node-header" [class.selected]="selectedNode?.id === actif.id">
                            <span class="node-icon">{{ getNodeIcon(actif) }}</span>
                            <span class="node-name">{{ actif.nom }}</span>
                            <span class="node-code">{{ actif.code }}</span>
                            <span class="node-status" [style.color]="getStatutColor(actif.statutOperationnel || '')">
                              {{ actif.statutOperationnel }}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Selected Node Details -->
        <div class="node-details" *ngIf="selectedNode">
          <h3>üìã D√©tails de l'Actif</h3>
          <div class="details-card">
            <div class="details-header">
              <span class="details-icon">{{ getNodeIcon(selectedNode) }}</span>
              <h4>{{ selectedNode.nom }}</h4>
            </div>
            <div class="details-content">
              <div class="detail-row" *ngIf="selectedNode.code">
                <span class="detail-label">Code:</span>
                <span class="detail-value">{{ selectedNode.code }}</span>
              </div>
              <div class="detail-row" *ngIf="selectedNode.numeroSerie">
                <span class="detail-label">N¬∞ S√©rie:</span>
                <span class="detail-value">{{ selectedNode.numeroSerie }}</span>
              </div>
              <div class="detail-row" *ngIf="selectedNode.statutOperationnel">
                <span class="detail-label">Statut:</span>
                <span class="detail-value status-badge" [style.color]="getStatutColor(selectedNode.statutOperationnel)">
                  {{ selectedNode.statutOperationnel }}
                </span>
              </div>
              <div class="detail-row" *ngIf="selectedNode.etatGeneral">
                <span class="detail-label">√âtat:</span>
                <span class="detail-value" [style.color]="getEtatColor(selectedNode.etatGeneral)">
                  {{ selectedNode.etatGeneral }}
                </span>
              </div>
              <div class="detail-row" *ngIf="selectedNode.latitude && selectedNode.longitude">
                <span class="detail-label">Coordonn√©es:</span>
                <span class="detail-value coordinates">
                  {{ selectedNode.latitude.toFixed(6) }}, {{ selectedNode.longitude.toFixed(6) }}
                </span>
              </div>
            </div>
            <div class="details-actions" *ngIf="selectedActif">
              <button class="btn btn-warning btn-sm" 
                      (click)="updateActifStatut(selectedActif.id, 'maintenance')">
                üîß Maintenance
              </button>
              <button class="btn btn-success btn-sm" 
                      (click)="updateActifStatut(selectedActif.id, 'operationnel')">
                ‚úÖ Op√©rationnel
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Tab -->
    <div class="tab-content" [class.active]="activeTab === 'map'">
      <div class="map-section">
        <h2>üó∫Ô∏è Carte Interactive des Actifs</h2>
        
        <!-- Map Controls -->
        <div class="map-controls">
          <div class="control-group">
            <label class="control-label">
              <input type="checkbox" [(ngModel)]="showActifsOnMap" (change)="toggleMapActifs()">
              <span>Afficher les actifs ({{ actifsPourCarte.length }})</span>
            </label>
          </div>
          
          <div class="control-group">
            <label class="control-label">
              <input type="checkbox" [(ngModel)]="showAnomaliesOnMap" (change)="toggleMapAnomalies()">
              <span>Afficher les anomalies</span>
            </label>
          </div>
          
          <div class="control-group">
            <select [(ngModel)]="selectedMapFilter" class="map-filter-select">
              <option value="tous">Tous les actifs</option>
              <option value="operationnel">Op√©rationnels</option>
              <option value="maintenance">En maintenance</option>
              <option value="hors_service">Hors service</option>
            </select>
          </div>
          
          <button class="btn btn-primary" (click)="centerMapOnActifs()">
            <span class="btn-icon">üìç</span>
            Centrer sur les actifs
          </button>
        </div>

        <!-- Embedded Map -->
        <div class="embedded-map">
          <iframe 
            [src]="getMapUrl()" 
            width="100%" 
            height="500px" 
            frameborder="0"
            style="border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
          </iframe>
        </div>

        <!-- Map Legend -->
        <div class="map-legend">
          <h4>L√©gende</h4>
          <div class="legend-items">
            <div class="legend-item">
              <span class="legend-color" style="background-color: #28a745;"></span>
              <span>Op√©rationnel</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #ffc107;"></span>
              <span>En maintenance</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #dc3545;"></span>
              <span>Hors service</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background-color: #fd7e14;"></span>
              <span>Alerte</span>
            </div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="map-actions">
          <button class="btn btn-warning" (click)="signalAnomalieFromMap()">
            <span class="btn-icon">‚ö†Ô∏è</span>
            Signaler une anomalie
          </button>
          <button class="btn btn-info" (click)="openFullMap()">
            <span class="btn-icon">üîç</span>
            Ouvrir la carte compl√®te
          </button>
        </div>
      </div>
    </div>

    <!-- Assets List Section - Enhanced -->
    <div class="tab-content" [class.active]="activeTab === 'assets'">
      <div class="assets-section">
        <div class="assets-header">
          <h2>üìã Liste des Actifs</h2>
          
          <!-- Enhanced Filters -->
          <div class="assets-filters">
            <div class="filter-group">
              <label>Statut:</label>
              <select [(ngModel)]="filtreStatut" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Tous les statuts</option>
                <option value="operationnel">Op√©rationnel</option>
                <option value="maintenance">En maintenance</option>
                <option value="hors_service">Hors service</option>
                <option value="alerte">Alerte</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Type:</label>
              <select [(ngModel)]="filtreType" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Tous les types</option>
                <option *ngFor="let type of getUniqueTypes()" [value]="type">{{ type }}</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Priorit√©:</label>
              <select [(ngModel)]="filtrePriorite" (change)="onFilterChange()" class="filter-select">
                <option value="tous">Toutes priorit√©s</option>
                <option value="critique">Critique (avec anomalies)</option>
                <option value="maintenance">Maintenance requise</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Recherche:</label>
              <input type="text" 
                     [(ngModel)]="rechercheTexte" 
                     (input)="onFilterChange()"
                     placeholder="Nom, code ou groupe..."
                     class="filter-input">
            </div>
          </div>
          
          <div class="assets-summary">
            <div class="summary-card">
              <span class="summary-count">{{ getFilteredActifs().length }}</span>
              <span class="summary-label">Actifs trouv√©s</span>
            </div>
            <div class="summary-card critical">
              <span class="summary-count">{{ getAssetsByPriority('critique').length }}</span>
              <span class="summary-label">Critiques</span>
            </div>
            <div class="summary-card warning">
              <span class="summary-count">{{ getAssetsByPriority('maintenance').length }}</span>
              <span class="summary-label">Maintenance requise</span>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Assets Grid -->
        <div class="assets-enhanced-grid">
          <div *ngFor="let actif of getFilteredActifs()" 
               class="asset-enhanced-card"
               [class.critical]="hasUrgentIssues(actif)"
               [class.maintenance-required]="needsMaintenance(actif)"
               (click)="selectActif(actif)">
               
            <!-- Asset Header -->
            <div class="asset-header-enhanced">
              <div class="asset-identity">
                <span class="asset-icon-enhanced">{{ getActifIcon(actif) }}</span>
                <div class="asset-title">
                  <h4>{{ actif.nom }}</h4>
                  <div class="asset-meta">
                    <span class="asset-code">{{ actif.code }}</span>
                    <span class="asset-group" *ngIf="actif.groupe">{{ actif.groupe }}</span>
                  </div>
                </div>
              </div>
              <div class="asset-status-badges">
                <span class="status-badge" [ngClass]="getStatusClass(actif.statutOperationnel)">
                  {{ actif.statutOperationnel }}
                </span>
                <span class="priority-badge" [ngClass]="getPriorityClass(actif)" *ngIf="getAssetPriority(actif) !== 'normal'">
                  {{ getAssetPriorityLabel(actif) }}
                </span>
              </div>
            </div>
            
            <!-- Asset Key Information -->
            <div class="asset-key-info">
              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Type:</span>
                  <span class="info-value">{{ actif.type }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">√âtat:</span>
                  <span class="info-value" [style.color]="getEtatColor(actif.etatGeneral)">
                    {{ actif.etatGeneral }}
                  </span>
                </div>
                <div class="info-item" *ngIf="actif.famille">
                  <span class="info-label">Famille:</span>
                  <span class="info-value">{{ actif.famille }}</span>
                </div>
                <div class="info-item" *ngIf="actif.portefeuille">
                  <span class="info-label">Portefeuille:</span>
                  <span class="info-value">{{ actif.portefeuille }}</span>
                </div>
              </div>
            </div>
            
            <!-- Issues & Maintenance Summary -->
            <div class="asset-issues-summary" *ngIf="hasIssuesOrMaintenance(actif)">
              <div class="issues-header">
                <h5>üîç √âtat Actuel</h5>
              </div>
              
              <div class="issue-items">
                <!-- Active Anomalies -->
                <div class="issue-item anomaly" *ngIf="actif.anomaliesActives > 0">
                  <div class="issue-icon">‚ö†Ô∏è</div>
                  <div class="issue-details">
                    <span class="issue-count">{{ actif.anomaliesActives }}</span>
                    <span class="issue-label">Anomalie(s) active(s)</span>
                    <button class="issue-action-btn" 
                            (click)="viewAnomaliesForActif(actif, $event)"
                            title="Voir les anomalies">
                      üëÅÔ∏è
                    </button>
                  </div>
                </div>
                
                <!-- Planned Maintenance -->
                <div class="issue-item maintenance" *ngIf="actif.maintenancesPrevues > 0">
                  <div class="issue-icon">üîß</div>
                  <div class="issue-details">
                    <span class="issue-count">{{ actif.maintenancesPrevues }}</span>
                    <span class="issue-label">Maintenance(s) pr√©vue(s)</span>
                    <button class="issue-action-btn" 
                            (click)="viewMaintenanceForActif(actif, $event)"
                            title="Voir les maintenances">
                      ÔøΩÔ∏è
                    </button>
                  </div>
                </div>
                
                <!-- No current issues -->
                <div class="issue-item normal" *ngIf="!hasIssuesOrMaintenance(actif)">
                  <div class="issue-icon">‚úÖ</div>
                  <div class="issue-details">
                    <span class="issue-label">Aucun probl√®me signal√©</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="asset-actions">
              <button class="action-btn primary" 
                      (click)="viewAssetDetails(actif, $event)"
                      title="D√©tails complets">
                üìä D√©tails
              </button>
              <button class="action-btn warning" 
                      (click)="createAnomalieForActif(actif, $event)"
                      title="Signaler une anomalie">
                ‚ö†Ô∏è Signaler
              </button>
              <button class="action-btn success" 
                      (click)="scheduleMaintenanceForActif(actif, $event)"
                      title="Planifier maintenance">
                üîß Maintenance
              </button>
              <button class="action-btn info" 
                      (click)="showActifOnMap(actif, $event)"
                      title="Localiser sur la carte">
                üó∫Ô∏è Carte
              </button>
            </div>
            
            <!-- Location Info -->
            <div class="asset-location" *ngIf="actif.latitude && actif.longitude">
              <span class="location-icon">üìç</span>
              <span class="location-coords">
                {{ formatCoordinates(actif) }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Empty state -->
        <div class="empty-state" *ngIf="getFilteredActifs().length === 0">
          <div class="empty-icon">üì≠</div>
          <h3>Aucun actif trouv√©</h3>
          <p>Essayez de modifier vos filtres ou votre recherche.</p>
        </div>
      </div>
    </div>

    <!-- Anomalies Tab -->
    <div class="tab-content" [class.active]="activeTab === 'anomalies'">
      <div class="anomalies-section">
        <div class="section-header">
          <h2>‚ö†Ô∏è Gestion des Anomalies</h2>
          <div class="anomalies-stats">
            <div class="stat-item">
              <span class="stat-number">{{ anomaliesData.length }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-item critical">
              <span class="stat-number">{{ getAnomaliesByPriorite('critique').length }}</span>
              <span class="stat-label">Critiques</span>
            </div>
            <div class="stat-item new">
              <span class="stat-number">{{ getAnomaliesByStatut('nouveau').length }}</span>
              <span class="stat-label">Nouvelles</span>
            </div>
          </div>
        </div>

        <!-- Liste des anomalies -->
        <div class="anomalies-list">
          <div *ngFor="let anomalie of anomaliesData" class="anomalie-card" 
               [class]="'priority-' + anomalie.priorite">
            <div class="anomalie-header">
              <div class="anomalie-info">
                <h4>{{ anomalie.titre }}</h4>
                <p class="anomalie-description">{{ anomalie.description }}</p>
              </div>
              <div class="anomalie-priority" [style.color]="getPrioriteColor(anomalie.priorite)">
                {{ anomalie.priorite?.toUpperCase() }}
              </div>
            </div>
            
            <div class="anomalie-details">
              <div class="detail-item">
                <strong>Type:</strong> {{ anomalie.typeAnomalie }}
              </div>
              <div class="detail-item">
                <strong>Statut:</strong> 
                <span [class]="'status-' + anomalie.statut">{{ anomalie.statut }}</span>
              </div>
              <div class="detail-item" *ngIf="anomalie.actif">
                <strong>Actif:</strong> {{ anomalie.actif.nom }} ({{ anomalie.actif.code }})
              </div>
              <div class="detail-item">
                <strong>D√©tect√© le:</strong> {{ anomalie.dateDetection | date:'dd/MM/yyyy HH:mm' }}
              </div>
              <div class="detail-item" *ngIf="anomalie.rapportePar">
                <strong>Rapport√© par:</strong> {{ anomalie.rapportePar }}
              </div>
            </div>
            
            <div class="anomalie-actions" *ngIf="anomalie.statut !== 'resolu'">
              <button class="btn btn-success btn-sm" (click)="resolveAnomalie(anomalie)">
                ‚úÖ R√©soudre
              </button>
            </div>
          </div>
          
          <div *ngIf="anomaliesData.length === 0" class="empty-state">
            <p>Aucune anomalie trouv√©e</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Maintenance Tab -->
    <div class="tab-content" [class.active]="activeTab === 'maintenance'">
      <div class="maintenance-section">
        <div class="section-header">
          <h2>üîß Gestion de la Maintenance</h2>
          <div class="maintenance-stats">
            <div class="stat-item">
              <span class="stat-number">{{ maintenanceData.length }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-item planned">
              <span class="stat-number">{{ getMaintenancesByStatut('planifiee').length }}</span>
              <span class="stat-label">Planifi√©es</span>
            </div>
            <div class="stat-item active">
              <span class="stat-number">{{ getMaintenancesByStatut('en_cours').length }}</span>
              <span class="stat-label">En Cours</span>
            </div>
          </div>
        </div>

        <!-- Liste des maintenances -->
        <div class="maintenance-list">
          <div *ngFor="let maintenance of maintenanceData" class="maintenance-card" 
               [class]="'type-' + maintenance.typeMaintenance">
            <div class="maintenance-header">
              <div class="maintenance-info">
                <h4>{{ maintenance.titre }}</h4>
                <p class="maintenance-description">{{ maintenance.description }}</p>
              </div>
              <div class="maintenance-type">
                {{ maintenance.typeMaintenance?.toUpperCase() }}
              </div>
            </div>
            
            <div class="maintenance-details">
              <div class="detail-item">
                <strong>Statut:</strong> 
                <span [class]="'status-' + maintenance.statut">{{ maintenance.statut }}</span>
              </div>
              <div class="detail-item" *ngIf="maintenance.actif">
                <strong>Actif:</strong> {{ maintenance.actif.nom }} ({{ maintenance.actif.code }})
              </div>
              <div class="detail-item">
                <strong>Date pr√©vue:</strong> {{ maintenance.datePrevue | date:'dd/MM/yyyy' }}
              </div>
              <div class="detail-item" *ngIf="maintenance.technicienResponsable">
                <strong>Technicien:</strong> {{ maintenance.technicienResponsable }}
              </div>
              <div class="detail-item" *ngIf="maintenance.coutEstime">
                <strong>Co√ªt estim√©:</strong> {{ formatCurrency(maintenance.coutEstime) }}
              </div>
            </div>
            
            <div class="maintenance-actions">
              <button class="btn btn-primary btn-sm" 
                      *ngIf="maintenance.statut === 'planifiee'"
                      (click)="startMaintenance(maintenance)">
                ‚ñ∂Ô∏è D√©marrer
              </button>
              <button class="btn btn-success btn-sm" 
                      *ngIf="maintenance.statut === 'en_cours'"
                      (click)="completeMaintenance(maintenance)">
                ‚úÖ Terminer
              </button>
            </div>
          </div>
          
          <div *ngIf="maintenanceData.length === 0" class="empty-state">
            <p>Aucune maintenance trouv√©e</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Asset Details Modal -->
<div class="modal fade" [class.show]="showAssetDetailsModal" [style.display]="showAssetDetailsModal ? 'block' : 'none'" *ngIf="showAssetDetailsModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">D√©tails de l'Actif</h5>
        <button type="button" class="btn-close" (click)="closeAssetDetailsModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        <div class="asset-details-content">
          <div class="row">
            <div class="col-md-6">
              <h6>Informations G√©n√©rales</h6>
              <dl class="row">
                <dt class="col-sm-4">Nom:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.nom }}</dd>
                <dt class="col-sm-4">Code:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.code }}</dd>
                <dt class="col-sm-4">Statut:</dt>
                <dd class="col-sm-8">
                  <span class="badge" [class]="'status-' + selectedAssetForAction.statutOperationnel">
                    {{ formatStatus(selectedAssetForAction.statutOperationnel) }}
                  </span>
                </dd>
                <dt class="col-sm-4">Priorit√©:</dt>
                <dd class="col-sm-8">
                  <span class="badge" [class]="'priority-' + getAssetPriority(selectedAssetForAction)">
                    {{ formatPriority(getAssetPriority(selectedAssetForAction)) }}
                  </span>
                </dd>
              </dl>
            </div>
            <div class="col-md-6">
              <h6>Hi√©rarchie & Localisation</h6>
              <dl class="row">
                <dt class="col-sm-4">Groupe:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.groupe || 'Non assign√©' }}</dd>
                <dt class="col-sm-4">Famille:</dt>
                <dd class="col-sm-8">{{ selectedAssetForAction.famille || 'Non assign√©e' }}</dd>
                <dt class="col-sm-4">Coordonn√©es:</dt>
                <dd class="col-sm-8">{{ formatCoordinates(selectedAssetForAction) }}</dd>
              </dl>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <h6>Anomalies Actives</h6>
              <div class="stat-box">
                <span class="stat-number">{{ getStatusCount(selectedAssetForAction, 'anomalies') }}</span>
                <span class="stat-label">anomalies en cours</span>
              </div>
            </div>
            <div class="col-md-6">
              <h6>Maintenances</h6>
              <div class="stat-box">
                <span class="stat-number">{{ getStatusCount(selectedAssetForAction, 'maintenance') }}</span>
                <span class="stat-label">maintenances pr√©vues</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" (click)="createAnomalieForActif(selectedAssetForAction!, $event)">
          Signaler Anomalie
        </button>
        <button type="button" class="btn btn-success" (click)="scheduleMaintenanceForActif(selectedAssetForAction!, $event)">
          Planifier Maintenance
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeAssetDetailsModal()">
          Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Create Anomalie Modal -->
<div class="modal fade" [class.show]="showCreateAnomalieModal" [style.display]="showCreateAnomalieModal ? 'block' : 'none'" *ngIf="showCreateAnomalieModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Signaler une Anomalie</h5>
        <button type="button" class="btn-close" (click)="closeCreateAnomalieModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        <p><strong>Actif concern√©:</strong> {{ selectedAssetForAction.nom }} ({{ selectedAssetForAction.code }})</p>
        
        <form [formGroup]="createAnomalieForm" (ngSubmit)="submitAnomalieForm()">
          <div class="mb-3">
            <label for="anomalieTitre" class="form-label">Titre de l'anomalie *</label>
            <input 
              type="text" 
              class="form-control" 
              id="anomalieTitre" 
              formControlName="titre"
              [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'titre')"
              placeholder="Titre descriptif de l'anomalie">
            <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'titre')">
              {{ getFieldError(createAnomalieForm, 'titre') }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="anomalieType" class="form-label">Type d'anomalie *</label>
            <select 
              class="form-select" 
              id="anomalieType"
              formControlName="typeAnomalie"
              [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'typeAnomalie')">
              <option value="">S√©lectionner un type</option>
              <option value="structural">Structurel</option>
              <option value="mecanique">M√©canique</option>
              <option value="electrique">√âlectrique</option>
              <option value="securite">S√©curit√©</option>
              <option value="autre">Autre</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'typeAnomalie')">
              {{ getFieldError(createAnomalieForm, 'typeAnomalie') }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="anomaliePriorite" class="form-label">Priorit√© *</label>
            <select 
              class="form-select" 
              id="anomaliePriorite"
              formControlName="priorite"
              [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'priorite')">
              <option value="">S√©lectionner une priorit√©</option>
              <option value="faible">Faible</option>
              <option value="moyen">Moyen</option>
              <option value="eleve">√âlev√©</option>
              <option value="critique">Critique</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'priorite')">
              {{ getFieldError(createAnomalieForm, 'priorite') }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="anomalieDescription" class="form-label">Description d√©taill√©e *</label>
            <textarea 
              class="form-control" 
              id="anomalieDescription" 
              rows="4" 
              formControlName="description"
              [class.is-invalid]="isFieldInvalid(createAnomalieForm, 'description')"
              placeholder="D√©crivez l'anomalie en d√©tail..."></textarea>
            <div class="invalid-feedback" *ngIf="isFieldInvalid(createAnomalieForm, 'description')">
              {{ getFieldError(createAnomalieForm, 'description') }}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="anomalieSubmitting || createAnomalieForm.invalid"
          (click)="submitAnomalieForm()">
          <span *ngIf="anomalieSubmitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ anomalieSubmitting ? 'Cr√©ation...' : 'Cr√©er Anomalie' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeCreateAnomalieModal()">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal fade" [class.show]="showScheduleMaintenanceModal" [style.display]="showScheduleMaintenanceModal ? 'block' : 'none'" *ngIf="showScheduleMaintenanceModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Planifier une Maintenance</h5>
        <button type="button" class="btn-close" (click)="closeScheduleMaintenanceModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedAssetForAction">
        <p><strong>Actif concern√©:</strong> {{ selectedAssetForAction.nom }} ({{ selectedAssetForAction.code }})</p>
        
        <form [formGroup]="scheduleMaintenanceForm" (ngSubmit)="submitMaintenanceForm()">
          <div class="mb-3">
            <label for="maintenanceTitre" class="form-label">Titre de la maintenance *</label>
            <input 
              type="text" 
              class="form-control" 
              id="maintenanceTitre" 
              formControlName="titre"
              [class.is-invalid]="isFieldInvalid(scheduleMaintenanceForm, 'titre')"
              placeholder="Titre de la maintenance">
            <div class="invalid-feedback" *ngIf="isFieldInvalid(scheduleMaintenanceForm, 'titre')">
              {{ getFieldError(scheduleMaintenanceForm, 'titre') }}
            </div>
          </div>
          
          <div class="mb-3">
            <label for="maintenanceType" class="form-label">Type de maintenance *</label>
            <select 
              class="form-select" 
              id="maintenanceType"
              formControlName="typeMaintenance"
              [class.is-invalid]="isFieldInvalid(scheduleMaintenanceForm, 'typeMaintenance')">
              <option value="">S√©lectionner un type</option>
              <option value="preventive">Pr√©ventive</option>
              <option value="corrective">Corrective</option>
              <option value="urgente">Urgente</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid(scheduleMaintenanceForm, 'typeMaintenance')">
              {{ getFieldError(scheduleMaintenanceForm, 'typeMaintenance') }}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="maintenanceDatePrevue" class="form-label">Date pr√©vue *</label>
                <input 
                  type="date" 
                  class="form-control" 
                  id="maintenanceDatePrevue"
                  formControlName="datePrevue"
                  [class.is-invalid]="isFieldInvalid(scheduleMaintenanceForm, 'datePrevue')">
                <div class="invalid-feedback" *ngIf="isFieldInvalid(scheduleMaintenanceForm, 'datePrevue')">
                  {{ getFieldError(scheduleMaintenanceForm, 'datePrevue') }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="maintenanceCoutEstime" class="form-label">Co√ªt estim√© (‚Ç¨)</label>
                <input 
                  type="number" 
                  class="form-control" 
                  id="maintenanceCoutEstime" 
                  formControlName="coutEstime"
                  [class.is-invalid]="isFieldInvalid(scheduleMaintenanceForm, 'coutEstime')"
                  placeholder="0.00"
                  step="0.01"
                  min="0">
                <div class="invalid-feedback" *ngIf="isFieldInvalid(scheduleMaintenanceForm, 'coutEstime')">
                  {{ getFieldError(scheduleMaintenanceForm, 'coutEstime') }}
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="maintenanceTechnicien" class="form-label">Technicien responsable</label>
            <input 
              type="text" 
              class="form-control" 
              id="maintenanceTechnicien" 
              formControlName="technicienResponsable"
              placeholder="Nom du technicien">
          </div>
          
          <div class="mb-3">
            <label for="maintenanceDescription" class="form-label">Description des travaux *</label>
            <textarea 
              class="form-control" 
              id="maintenanceDescription" 
              rows="4" 
              formControlName="description"
              [class.is-invalid]="isFieldInvalid(scheduleMaintenanceForm, 'description')"
              placeholder="D√©crivez les travaux de maintenance..."></textarea>
            <div class="invalid-feedback" *ngIf="isFieldInvalid(scheduleMaintenanceForm, 'description')">
              {{ getFieldError(scheduleMaintenanceForm, 'description') }}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button 
          type="submit" 
          class="btn btn-primary"
          [disabled]="maintenanceSubmitting || scheduleMaintenanceForm.invalid"
          (click)="submitMaintenanceForm()">
          <span *ngIf="maintenanceSubmitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ maintenanceSubmitting ? 'Planification...' : 'Planifier Maintenance' }}
        </button>
        <button type="button" class="btn btn-secondary" (click)="closeScheduleMaintenanceModal()">
          Annuler
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal backdrop -->
<div class="modal-backdrop fade show" *ngIf="showAssetDetailsModal || showCreateAnomalieModal || showScheduleMaintenanceModal"></div>
