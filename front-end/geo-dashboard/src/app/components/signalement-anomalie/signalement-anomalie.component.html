<div class="signalement-container">
  <div class="form-card">
    <!-- Header Section -->
    <div class="form-header">
      <h2 class="form-title">
        <span class="section-icon">‚ö†Ô∏è</span>
        Signalement d'Anomalie
      </h2>
      <p class="form-subtitle">
        D√©clarer une anomalie pour une intervention rapide et efficace
      </p>
    </div>

    <!-- Success Alert -->
    <div *ngIf="showSuccess" class="alert alert-success">
      <i class="fas fa-check-circle me-2"></i>
      <strong>Succ√®s!</strong> Anomalie signal√©e avec succ√®s !
    </div>

    <!-- Error Alert -->
    <div *ngIf="errorMessage" class="alert alert-danger">
      <i class="fas fa-exclamation-circle me-2"></i>
      <strong>Erreur:</strong> {{ errorMessage }}
    </div>

    <form [formGroup]="signalementForm" (ngSubmit)="onSubmit()">
      
      <!-- Basic Information Section -->
      <div class="form-section">
        <div class="section-header">
          <span class="section-icon">üìã</span>
          <div>
            <h4 class="section-title">Informations G√©n√©rales</h4>
            <p class="section-description">Identifiez l'anomalie et l'actif concern√©</p>
          </div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-group">
              <label for="titre" class="form-label required">
                <span class="label-icon">üè∑Ô∏è</span>
                Titre de l'Anomalie
              </label>
              <input 
                type="text" 
                id="titre"
                class="form-control form-control-sm"
                [class.is-invalid]="isFieldInvalid('titre')"
                [class.is-valid]="signalementForm.get('titre')?.valid && signalementForm.get('titre')?.touched"
                formControlName="titre"
                placeholder="Ex: D√©fense endommag√©e sur quai C1">
              <div *ngIf="isFieldInvalid('titre')" class="invalid-feedback">
                {{ getFieldErrorMessage('titre') }}
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="form-group">
              <label for="rapportePar" class="form-label">
                <span class="label-icon">üë§</span>
                Rapport√© par
              </label>
              <input 
                type="text" 
                id="rapportePar"
                class="form-control form-control-sm"
                formControlName="rapportePar"
                placeholder="Nom de la personne qui rapporte l'anomalie">
              <div class="form-text">
                <i class="fas fa-info-circle icon"></i>
                Optionnel - Nom de l'agent qui signale l'anomalie
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-md-12">
            <div class="form-group">
              <label class="form-label required">
                <span class="label-icon">üè≠</span>
                Actif Concern√©
              </label>
              <!-- Always show auto-selected asset card -->
              <div class="selected-asset-display" *ngIf="selectedAsset; else noAssetSelected">
                <div class="asset-info-card compact">
                  <div class="asset-icon"><i class="fas fa-cog"></i></div>
                  <div class="asset-details">
                    <h5 class="asset-name">{{ getSelectedAssetName() || 'Actif s√©lectionn√©' }}</h5>
                    <small class="asset-hint text-muted">{{ getSelectedAssetName() || '‚Äî' }}</small>
                  </div>
                  <div class="asset-status">
                    <span class="badge bg-light text-secondary border"><i class="fas fa-check me-1"></i>S√©lectionn√©</span>
                  </div>
                </div>
                <input type="hidden" formControlName="actifId" />
              </div>
              <ng-template #noAssetSelected>
                <div class="alert alert-warning p-2">
                  Aucun actif n'a √©t√© transmis. Fermez et s√©lectionnez un actif sur la carte.
                </div>
              </ng-template>
            </div>
          </div>
        </div>
      </div>

      <!-- Description & Classification Section -->
      <div class="form-section">
        <div class="section-header">
          <span class="section-icon">üìù</span>
          <div>
            <h4 class="section-title">Description et Classification</h4>
            <p class="section-description">D√©crivez et cat√©gorisez l'anomalie</p>
          </div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-7">
            <div class="form-group">
              <label for="description" class="form-label required">
                <span class="label-icon">üìÑ</span>
                Description de l'Anomalie
              </label>
              <textarea 
                id="description"
                class="form-control form-control-sm"
                [class.is-invalid]="isFieldInvalid('description')"
                [class.is-valid]="signalementForm.get('description')?.valid && signalementForm.get('description')?.touched"
                formControlName="description"
                rows="4"
                placeholder="D√©crivez l'anomalie observ√©e, les sympt√¥mes, les risques potentiels..."></textarea>
              <div *ngIf="isFieldInvalid('description')" class="invalid-feedback">
                {{ getFieldErrorMessage('description') }}
              </div>
            </div>
          </div>
          
          <div class="col-md-5">
            <div class="form-group">
              <label for="typeAnomalie" class="form-label required">
                <span class="label-icon">üîß</span>
                Type d'Anomalie
              </label>
              <select 
                id="typeAnomalie"
                class="form-select form-select-sm"
                [class.is-invalid]="isFieldInvalid('typeAnomalie')"
                [class.is-valid]="signalementForm.get('typeAnomalie')?.valid && signalementForm.get('typeAnomalie')?.touched"
                formControlName="typeAnomalie">
                <option value="" disabled>S√©lectionnez un type</option>
                <option *ngFor="let type of typesAnomalies" [value]="type.value">
                  {{ type.label }}
                </option>
              </select>
              <div *ngIf="isFieldInvalid('typeAnomalie')" class="invalid-feedback">
                {{ getFieldErrorMessage('typeAnomalie') }}
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label required">
                <span class="label-icon">‚ö°</span>
                Niveau de Priorit√©
              </label>
              <div class="priority-grid">
                <div *ngFor="let priorite of priorites" class="priority-option">
                  <div class="form-check">
                    <input 
                      class="form-check-input" 
                      type="radio" 
                      [id]="'priorite-' + priorite.value"
                      [value]="priorite.value"
                      formControlName="priorite">
                    <label class="form-check-label" [for]="'priorite-' + priorite.value">
                      <span class="priority-indicator" [style.background-color]="priorite.color"></span>
                      <span class="priority-text">{{ priorite.label }}</span>
                    </label>
                  </div>
                </div>
              </div>
              <div *ngIf="isFieldInvalid('priorite')" class="invalid-feedback">
                {{ getFieldErrorMessage('priorite') }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Photos Annexes Section -->
      <div class="form-section">
        <div class="section-header">
          <span class="section-icon">üì∏</span>
          <div>
            <h4 class="section-title">Photos Annexes</h4>
            <p class="section-description">Ajoutez des photos pour documenter l'anomalie (optionnel)</p>
          </div>
        </div>

        <div class="photo-upload-zone">
          <input
            type="file"
            id="imageUpload"
            class="d-none"
            accept="image/*"
            multiple
            (change)="onFileSelected($event)">

          <label for="imageUpload" class="upload-area"
                 [class.has-file]="selectedFiles.length > 0">
            <div class="upload-content">
              <i class="fas fa-cloud-upload-alt upload-icon"></i>
              <h5 class="upload-title">Cliquez pour ajouter des photos</h5>
              <p class="upload-text">
                Formats accept√©s: JPG, PNG, GIF<br>
                Taille max: 5MB par fichier
              </p>
            </div>
          </label>

          <!-- Image Previews -->
          <div *ngIf="imagePreviews.length > 0" class="image-previews mt-3">
            <div class="preview-grid">
              <div *ngFor="let preview of imagePreviews; let i = index" class="image-preview-item">
                <div class="preview-container">
                  <img [src]="preview.url" [alt]="preview.name" class="preview-image">
                  <button type="button"
                          class="btn btn-danger btn-sm remove-image"
                          (click)="removeImage(i)"
                          [title]="'Supprimer ' + preview.name">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                <div class="image-info">
                  <small class="text-muted">{{ preview.name }}</small>
                  <small class="text-muted d-block">{{ preview.size }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Location Section -->
      <div class="form-section">
        <div class="section-header">
          <span class="section-icon">üìç</span>
          <div>
            <h4 class="section-title">Coordonn√©es GPS</h4>
            <p class="section-description">Position g√©ographique de l'anomalie</p>
          </div>
        </div>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="form-group">
              <label for="latitude" class="form-label required">
                <span class="label-icon">üåê</span>
                Latitude
              </label>
              <input 
                type="number" 
                id="latitude"
                class="form-control form-control-sm"
                [class.is-invalid]="isFieldInvalid('latitude')"
                [class.is-valid]="signalementForm.get('latitude')?.valid && signalementForm.get('latitude')?.touched"
                formControlName="latitude"
                step="0.0000001"
                placeholder="Ex: 36.7377">
              <div *ngIf="isFieldInvalid('latitude')" class="invalid-feedback">
                {{ getFieldErrorMessage('latitude') }}
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-group">
              <label for="longitude" class="form-label required">
                <span class="label-icon">üåç</span>
                Longitude
              </label>
              <input 
                type="number" 
                id="longitude"
                class="form-control form-control-sm"
                [class.is-invalid]="isFieldInvalid('longitude')"
                [class.is-valid]="signalementForm.get('longitude')?.valid && signalementForm.get('longitude')?.touched"
                formControlName="longitude"
                step="0.0000001"
                placeholder="Ex: 3.0637">
              <div *ngIf="isFieldInvalid('longitude')" class="invalid-feedback">
                {{ getFieldErrorMessage('longitude') }}
              </div>
            </div>
          </div>
        </div>
        
        <div class="form-text mt-2">
          <i class="fas fa-map-marker-alt icon"></i>
          Cliquez sur la carte pour d√©finir automatiquement les coordonn√©es
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-outline-secondary" (click)="onCancel()">
          <i class="fas fa-times me-2"></i>
          Annuler
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="signalementForm.invalid || isSubmitting">
          <i class="fas fa-paper-plane me-2"></i>
          {{ isSubmitting ? 'Envoi en cours...' : 'Signaler l\'Anomalie' }}
        </button>
      </div>
    </form>
  </div>
</div>